<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="全栈开发实战：用Vue2+Koa1开发完整的前后端项目（更新Koa2）"><meta name="keywords" content="前端,Vue,Nodejs,Koa"><meta name="author" content="Molunerfinn"><meta name="copyright" content="Molunerfinn"><title>全栈开发实战：用Vue2+Koa1开发完整的前后端项目（更新Koa2） | MARKSZのBlog</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><link rel="manifest" href="/manifest.json"><link rel="manifest" href="/manifest.json"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle=window.adsbygoogle||[]).push({google_ad_client:"ca-pub-2358465699478507",enable_page_level_ads:"true"})</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?19a7ebdbb87f2403773c7ab0cae16d21";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-105869658-1","auto"),ga("send","pageview")</script><script>var GLOBAL_CONFIG={root:"/",algolia:{appId:"BGLU1ICJFH",apiKey:"85948beeaf121424b806828adc21c8b5",indexName:"mofinn",hits:{per_page:10},languages:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}.",hits_stats:"${hits} results found in ${time} ms"}},localSearch:void 0,copy:{success:"Copy successfully",error:"Copy error",noSupport:"The browser does not support"}}</script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#写在前面"><span class="toc-number">2.</span> <span class="toc-text">写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目结构"><span class="toc-number">3.</span> <span class="toc-text">项目结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目用到的一些关键依赖"><span class="toc-number">4.</span> <span class="toc-text">项目用到的一些关键依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目启动"><span class="toc-number">5.</span> <span class="toc-text">项目启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#前端页面构建"><span class="toc-number">6.</span> <span class="toc-text">前端页面构建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#登录界面"><span class="toc-number">6.1.</span> <span class="toc-text">登录界面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TodoList页面"><span class="toc-number">6.2.</span> <span class="toc-text">TodoList页面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#页面路由"><span class="toc-number">6.3.</span> <span class="toc-text">页面路由</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#后端环境搭建"><span class="toc-number">7.</span> <span class="toc-text">后端环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL"><span class="toc-number">7.1.</span> <span class="toc-text">MySQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sequelize"><span class="toc-number">7.2.</span> <span class="toc-text">Sequelize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-Test"><span class="toc-number">7.3.</span> <span class="toc-text">API Test</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#登录系统的实现"><span class="toc-number">7.4.</span> <span class="toc-text">登录系统的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JSON-WEB-TOKEN"><span class="toc-number">7.4.1.</span> <span class="toc-text">JSON-WEB-TOKEN</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#引入Axios"><span class="toc-number">7.4.2.</span> <span class="toc-text">引入Axios</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#密码bcrypt加密"><span class="toc-number">7.4.3.</span> <span class="toc-text">密码bcrypt加密</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#跳转拦截"><span class="toc-number">7.4.4.</span> <span class="toc-text">跳转拦截</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#解析token"><span class="toc-number">7.4.5.</span> <span class="toc-text">解析token</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Todolist-增删改查的实现"><span class="toc-number">8.</span> <span class="toc-text">Todolist 增删改查的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Token的发送"><span class="toc-number">8.1.</span> <span class="toc-text">Token的发送</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Koa端对Token的验证"><span class="toc-number">8.2.</span> <span class="toc-text">Koa端对Token的验证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#前端对接接口"><span class="toc-number">8.3.</span> <span class="toc-text">前端对接接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Todolist的改、删"><span class="toc-number">8.4.</span> <span class="toc-text">Todolist的改、删</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#项目部署"><span class="toc-number">9.</span> <span class="toc-text">项目部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Webpack打包"><span class="toc-number">9.1.</span> <span class="toc-text">Webpack打包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Koa-serve静态资源"><span class="toc-number">9.2.</span> <span class="toc-text">Koa serve静态资源</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-Test-1"><span class="toc-number">9.3.</span> <span class="toc-text">API Test</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx配置"><span class="toc-number">9.4.</span> <span class="toc-text">Nginx配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#写在最后"><span class="toc-number">10.</span> <span class="toc-text">写在最后</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://ws1.sinaimg.cn/large/8700af19ly1fm4iuz15lsj20ix0iw0u8"></div><div class="author-info__name text-center">Molunerfinn</div><div class="author-info__description text-center">For MElody</div><div class="follow-button"><a href="https://github.com/Molunerfinn">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">71</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">24</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">23</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://molunerfinn.com">Molunerfinn</a><a class="author-info-links__name text-center" href="https://elody-07.github.io">Elody</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image:url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div id="page-header"><span class="pull-left"><a id="site-name" href="/">MARKSZのBlog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/about">About</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">全栈开发实战：用Vue2+Koa1开发完整的前后端项目（更新Koa2）</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2017-05-03</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Web/">Web</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Web/开发/">开发</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Web/开发/Nodejs/">Nodejs</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">14.4k</span><span class="post-meta__separator">|</span><span>Reading time: 55 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>本文从一名新手的角度（默认对Vue有了解，对Koa或者Express有了解）出发，从0开始构建一个数据通过Koa提供API的形式获取，页面通过Vue渲染的完整的前端项目。可以了解到Vue构建单页面的一些知识以及前端路由的使用、Koa如何提供API接口，如何进行访问过滤（路由）、验证（JSON-WEB-TOKEN）以及Sequelize操作MySQL数据库的一些知识和技巧，希望能够作为一篇入门全栈开发的文章吧。</p><p><strong>更新</strong>：文末给出的github仓库已经更新Koa2版本。请使用Node.js v7.6.0及以上版本体验~</p><a id="more"></a><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>我曾经写过一篇<a href="https://molunerfinn.com/nodejs-2/">文章</a>，是用express和mongodb入门Nodejs的前后端开发，这篇文章里简单的做了一个小demo，能够让你读写mongodb数据库，并且从数据库里将数据读取出来显示到页面上。算是一个简单的读写小demo吧，也算是服务端渲染的一次初尝试。并且我还写过用nodejs写简单小爬虫的<a href="https://molunerfinn.com/nodejs-1/">文章</a>，用爬虫来获取数据写入数据库。通过以上的的方法我用express写了一个小网站，记录并显示北邮人论坛每天的十大的<a href="http://topten.piegg.cn" target="_blank" rel="noopener">内容</a>。挺好玩的对吧，可以把想要做的事用代码来实现。</p><p>后来我接触到了Koa，并开始了学习，从express迁移到Koa其实曲线还算是比较平滑的。不过用Koa的方式也还是采用服务端渲染页面的方式。而且我发现目前网络上少有写过用Koa构建的前后端分离的应用、网站文章，我最近做的一个项目里需要用到的方式就是用Vue构建页面，数据的获取全部走后端API的形式，也就是所谓的前后端分离吧。正好在这过程中走了不少的坑，包括数据库的使用上也算是个新手，所以写篇文章记录一下，用同样的思路和方法构建一个简单的Todolist，欢迎讨论，轻拍~</p><h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── LICENSE</span><br><span class="line">├── README.md</span><br><span class="line">├── .env  // 环境变量配置文件</span><br><span class="line">├── app.js  // Koa入口文件</span><br><span class="line">├── build // vue-cli 生成，用于webpack监听、构建</span><br><span class="line">│   ├── build.js</span><br><span class="line">│   ├── check-versions.js</span><br><span class="line">│   ├── dev-client.js</span><br><span class="line">│   ├── dev-server.js</span><br><span class="line">│   ├── utils.js</span><br><span class="line">│   ├── webpack.base.conf.js</span><br><span class="line">│   ├── webpack.dev.conf.js</span><br><span class="line">│   └── webpack.prod.conf.js</span><br><span class="line">├── config // vue-cli 生成&amp;自己加的一些配置文件</span><br><span class="line">│   ├── default.conf</span><br><span class="line">│   ├── dev.env.js</span><br><span class="line">│   ├── index.js</span><br><span class="line">│   └── prod.env.js</span><br><span class="line">├── dist // Vue build 后的文件夹</span><br><span class="line">│   ├── index.html // 入口文件</span><br><span class="line">│   └── static // 静态资源</span><br><span class="line">├── index.html // vue-cli生成，用于容纳Vue组件的主html文件。单页应用就只有一个html</span><br><span class="line">├── package.json // npm的依赖、项目信息文件</span><br><span class="line">├── server // Koa后端，用于提供Api</span><br><span class="line">│   ├── config // 配置文件夹</span><br><span class="line">│   ├── controllers // controller-控制器</span><br><span class="line">│   ├── models // model-模型</span><br><span class="line">│   ├── routes // route-路由</span><br><span class="line">│   └── schema // schema-数据库表结构</span><br><span class="line">├── src // vue-cli 生成&amp;自己添加的utils工具类</span><br><span class="line">│   ├── App.vue // 主文件</span><br><span class="line">│   ├── assets // 相关静态资源存放</span><br><span class="line">│   ├── components // 单文件组件</span><br><span class="line">│   ├── main.js // 引入Vue等资源、挂载Vue的入口js</span><br><span class="line">│   └── utils // 工具文件夹-封装的可复用的方法、功能</span><br><span class="line">└── yarn.lock // 用yarn自动生成的lock文件</span><br></pre></td></tr></table></figure><p>看起来好像很复杂的样子，其实很大一部分文件夹的结构是<code>vue-cli</code>这个工具帮我们生成的。而我们需要额外添加的主要是Koa的入口文件以及一个<code>server</code>文件夹用于Koa提供API。这样的话，在获取数据的方面就可以走Koa所提供的API，而Vue只需关心怎么把这些数据渲染到页面上就好了。</p><h2 id="项目用到的一些关键依赖"><a href="#项目用到的一些关键依赖" class="headerlink" title="项目用到的一些关键依赖"></a>项目用到的一些关键依赖</h2><p>以下依赖的版本都是本文所写的时候的版本，或者更旧一些</p><ul><li>Vue.js(v2.1.8)</li><li>Vue-Router(v2.1.1)</li><li>Axios(v0.15.3)</li><li>Element(v1.1.2)</li><li>Koa.js(v1.2.4) // 没采用Koa2</li><li><a href="mailto:Koa-Router@5.4" target="_blank" rel="noopener">Koa-Router@5.4</a>\Koa-jwt\Koa-static等一系列Koa中间件</li><li>Mysql(v2.12.0) // nodejs的mysql驱动，并不是mysql本身版本（项目采用mysql5.6）</li><li>Sequelize(v3.28.0) // 操作数据库的ORM</li><li>Yarn(v0.18.1) // 比起npm更快一些</li></ul><p>剩下依赖可以参考本文最后给出的项目demo仓库。</p><h2 id="项目启动"><a href="#项目启动" class="headerlink" title="项目启动"></a>项目启动</h2><p>Nodejs与npm的安装不再叙述（希望大家装上的node版本大于等于6.x，不然还需要加上–harmony标志才可以开启es6），默认读者已经掌握npm安装依赖的方法。首先全局安装<code>npm i vue-cli -g</code>，当然本项目基本上是采用<code>yarn</code>，所以也可以<code>yarn global add vue-cli</code>。</p><blockquote><p>Tips: 可以给yarn换上淘宝源，速度更快: <code>yarn config set registry &quot;https://registry.npm.taobao.org&quot;</code></p></blockquote><p>然后我们初始化一个<code>Vue2的webpack</code>的模板：</p><p><code>vue init webpack demo</code></p><blockquote><p>Tips: 上面的demo可以填写你自己的项目名称</p></blockquote><p>然后进行一些基本配置选择之后，你就可以得到一个基本的<code>vue-cli</code>生成的项目结构。</p><p>接着我们进入<code>vue-cli</code>生成的目录，安装<code>Vue</code>的项目依赖并安装<code>Koa</code>的项目依赖：<code>yarn &amp;&amp; yarn add koa koa-router@5.4 koa-logger koa-json koa-bodyparser</code>，（注意是安装<code>koa-router</code>的5.4版，因为7.X版本是支持Koa2的）然后进行一些基本目录建立：</p><p>在<code>vue-cli</code>生成的<code>demo</code>目录下，建立<code>server</code>文件夹以及子文件夹：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">├── server // Koa后端，用于提供Api</span><br><span class="line">    ├── config // 配置文件夹</span><br><span class="line">    ├── controllers // controller-控制器</span><br><span class="line">    ├── models // model-模型</span><br><span class="line">    ├── routes // route-路由</span><br><span class="line">    └── schema // schema-数据库表结构</span><br></pre></td></tr></table></figure><p>然后在<code>demo</code>文件夹下我们创建一个<code>app.js</code>的文件，作为<code>Koa</code>的启动文件。</p><p>写入如下基本的内容就可以启动<code>Koa</code>啦：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'koa'</span>)()</span><br><span class="line">  , koa = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</span><br><span class="line">  , json = <span class="built_in">require</span>(<span class="string">'koa-json'</span>)</span><br><span class="line">  , logger = <span class="built_in">require</span>(<span class="string">'koa-logger'</span>); <span class="comment">// 引入各种依赖</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>)());</span><br><span class="line">app.use(json());</span><br><span class="line">app.use(logger());</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>* (<span class="params">next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>;</span><br><span class="line">  <span class="keyword">yield</span> next;</span><br><span class="line">  <span class="keyword">let</span> ms = <span class="keyword">new</span> <span class="built_in">Date</span> - start;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'%s %s - %s'</span>, <span class="keyword">this</span>.method, <span class="keyword">this</span>.url, ms); <span class="comment">// 显示执行的时间</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, ctx</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'server error'</span>, err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">8889</span>,() =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Koa is listening in 8889'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></figure><p>然后在控制台输入<code>node app.js</code>，能看到输出<code>Koa is listening in 8889</code>，则说明我们的<code>Koa</code>已经启动成功了，并在8889端口监听。</p><h2 id="前端页面构建"><a href="#前端页面构建" class="headerlink" title="前端页面构建"></a>前端页面构建</h2><p>这个DEMO是做一个Todo-List，我们首先来做一个登录页面。</p><blockquote><p>Tips: 为了方便构建页面和美观，本文采用的Vue2的前端UI框架是<code>element-ui</code>。安装：<code>yarn add element-ui</code></p></blockquote><p>模板引擎我习惯用<code>pug</code>，CSS预处理我习惯用<code>stylus</code>，当然每个人自己的习惯和喜好是不一样的，所以大家根据自己平时的喜好来就行了。</p><p>为了方便大家查看代码，就不用<code>pug</code>了，学习成本相对高一些。不过CSS用<code>stylus</code>写起来简便，看起来也不会难懂，是我自己的习惯，所以还需要安装一下<code>yarn add stylus stylus-loader</code>。</p><blockquote><p>Tips: 安装stylus-loader是为了让webpack能够渲染stylus</p></blockquote><p>然后要把<code>element-ui</code>引入项目中。打开<code>src/main.js</code>，将文件改写如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line"><span class="keyword">import</span> ElementUI <span class="keyword">from</span> <span class="string">'element-ui'</span> <span class="comment">// 引入element-ui</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'element-ui/lib/theme-default/index.css'</span></span><br><span class="line"></span><br><span class="line">Vue.use(ElementUI) <span class="comment">// Vue全局使用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  el: <span class="string">'#app'</span>,</span><br><span class="line">  template: <span class="string">'&lt;App/&gt;'</span>,</span><br><span class="line">  components: &#123; App &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>然后我们在项目根目录下输入<code>npm run dev</code>，启动开发模式，这个模式有webpack的热加载，也就是你写完代码，浏览器立即就能响应变化。</p><p>为了实现响应式页面，我们要在项目目录下的<code>index.html</code>的<code>head</code>标签内加入以下<code>meta</code>：</p><p><code>&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0&quot;&gt;</code></p><h3 id="登录界面"><a href="#登录界面" class="headerlink" title="登录界面"></a>登录界面</h3><p>进入<code>src/components</code>目录，新建一个<code>Login.vue</code>的文件。然后我们来写第一个页面：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-row</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-col</span> <span class="attr">:xs</span>=<span class="string">"24"</span> <span class="attr">:sm</span>=<span class="string">"&#123;span: 6,offset: 9&#125;"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"title"</span>&gt;</span></span><br><span class="line">       欢迎登录 </span><br><span class="line">      <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-row</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-input</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">v-model</span>=<span class="string">"account"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">placeholder</span>=<span class="string">"账号"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">"text"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-input</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">v-model</span>=<span class="string">"password"</span> </span></span><br><span class="line"><span class="tag">          <span class="attr">placeholder</span>=<span class="string">"密码"</span></span></span><br><span class="line"><span class="tag">          <span class="attr">type</span>=<span class="string">"password"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-button</span> <span class="attr">type</span>=<span class="string">"primary"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">el-row</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-col</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">el-row</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">  data () &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">      account: <span class="string">''</span>,</span></span><br><span class="line"><span class="javascript">      password: <span class="string">''</span></span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">"stylus"</span> <span class="attr">scoped</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">  <span class="selector-class">.el-row</span><span class="selector-class">.content</span></span></span><br><span class="line"><span class="undefined">    padding 16px</span></span><br><span class="line"><span class="css">  <span class="selector-class">.title</span></span></span><br><span class="line"><span class="undefined">    font-size 28px</span></span><br><span class="line"><span class="css">  <span class="selector-class">.el-input</span></span></span><br><span class="line"><span class="undefined">    margin 12px 0</span></span><br><span class="line"><span class="css">  <span class="selector-class">.el-button</span></span></span><br><span class="line"><span class="undefined">    width 100%</span></span><br><span class="line"><span class="undefined">    margin-top 12px    </span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在这里就有一些值得注意的地方。首先是<code>template</code>标签内的直接子元素最多只能挂载一个。也就是你不能这么写：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-row</span>&gt;</span><span class="tag">&lt;/<span class="name">el-row</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-row</span>&gt;</span><span class="tag">&lt;/<span class="name">el-row</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>否则会报错：<code>template syntax error Component template should contain exactly one root element</code>，template下只能有一个根元素。不过为了写多个元素，你可以这样：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-row</span>&gt;</span><span class="tag">&lt;/<span class="name">el-row</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-row</span>&gt;</span><span class="tag">&lt;/<span class="name">el-row</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>同时注意到，在<code>Login.vue</code>的<code>style</code>标签内有个<code>scoped</code>属性，这个属性能够使这些样式只在这个组件内生效（因为Webpack在渲染的时候会将这个组件内的元素自动打上一串形如<code>data-v-62a7f97e</code>这样的属性，对于这些样式也会变成形如<code>.title[data-v-62a7f97e]{ font-size: 28px;}</code>的样子，保证了不会和其他组件的样式冲突。</p><p>页面写完之后，如果不把组件注册到Vue之下那么页面是不会显示的。因此这个时候需要把<code>APP.vue</code>这个文件改写一下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"./assets/logo.png"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Login</span>&gt;</span><span class="tag">&lt;/<span class="name">Login</span>&gt;</span> <span class="comment">&lt;!--使用Login组件--&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> Login <span class="keyword">from</span> <span class="string">'./components/Login'</span> <span class="comment">// 引入Login组件</span></span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">  name: <span class="string">'app'</span>,</span></span><br><span class="line"><span class="undefined">  components: &#123;</span></span><br><span class="line"><span class="javascript">    Login <span class="comment">// 注册组件</span></span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-id">#app</span> &#123;</span></span><br><span class="line"><span class="undefined">  font-family: 'Avenir', Helvetica, Arial, sans-serif;</span></span><br><span class="line"><span class="undefined">  -webkit-font-smoothing: antialiased;</span></span><br><span class="line"><span class="undefined">  -moz-osx-font-smoothing: grayscale;</span></span><br><span class="line"><span class="undefined">  text-align: center;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#2c3e50</span>;</span></span><br><span class="line"><span class="undefined">  margin-top: 60px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>也就是把<code>Login</code>这个组件注册到<code>Vue</code>下，同时你再看浏览器，已经不再是<code>vue-cli</code>默认生成的<code>Hello</code>欢迎界面了。</p><p><img src="https://img.piegg.cn/vue-koa-demo/login.png" alt="Login" title="Login"></p><p>接着我们写一下登录成功后的界面。</p><h3 id="TodoList页面"><a href="#TodoList页面" class="headerlink" title="TodoList页面"></a>TodoList页面</h3><p>还是在<code>src/components</code>目录下，写一个叫做<code>TodoList.vue</code>的文件。</p><p>接着我们开始写一个TodoList：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">el-row</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-col</span> <span class="attr">:xs</span>=<span class="string">"&#123;span:20,offset:2&#125;"</span> <span class="attr">:sm</span>=<span class="string">"&#123;span:8,offset:8&#125;"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">        欢迎：&#123;&#123;name&#125;&#125;！你的待办事项是：</span><br><span class="line">      <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-input</span> <span class="attr">placeholder</span>=<span class="string">"请输入待办事项"</span> <span class="attr">v-model</span>=<span class="string">"todos"</span> @<span class="attr">keyup.enter.native</span>=<span class="string">"addTodos"</span>&gt;</span><span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">el-tabs</span> <span class="attr">v-model</span>=<span class="string">"activeName"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-tab-pane</span> <span class="attr">label</span>=<span class="string">"待办事项"</span> <span class="attr">name</span>=<span class="string">"first"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">el-col</span> <span class="attr">:xs</span>=<span class="string">"24"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-if</span>=<span class="string">"!Done"</span>&gt;</span> <span class="comment">&lt;!--v-if和v-for不能同时在一个元素内使用，因为Vue总会先执行v-for--&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-for</span>=<span class="string">"(item, index) in list"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"todo-list"</span> <span class="attr">v-if</span>=<span class="string">"item.status == false"</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span></span><br><span class="line">                    &#123;&#123; index + 1 &#125;&#125;. &#123;&#123; item.content &#125;&#125;</span><br><span class="line">                  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"pull-right"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">el-button</span> <span class="attr">size</span>=<span class="string">"small"</span> <span class="attr">type</span>=<span class="string">"primary"</span> @<span class="attr">click</span>=<span class="string">"finished(index)"</span>&gt;</span>完成<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">el-button</span> <span class="attr">size</span>=<span class="string">"small"</span> <span class="attr">:plain</span>=<span class="string">"true"</span> <span class="attr">type</span>=<span class="string">"danger"</span> @<span class="attr">click</span>=<span class="string">"remove(index)"</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">template</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else-if</span>=<span class="string">"Done"</span>&gt;</span></span><br><span class="line">              暂无待办事项</span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">el-col</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">el-tab-pane</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">el-tab-pane</span> <span class="attr">label</span>=<span class="string">"已完成事项"</span> <span class="attr">name</span>=<span class="string">"second"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-if</span>=<span class="string">"count &gt; 0"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-for</span>=<span class="string">"(item, index) in list"</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"todo-list"</span> <span class="attr">v-if</span>=<span class="string">"item.status == true"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"item finished"</span>&gt;</span></span><br><span class="line">                  &#123;&#123; index + 1 &#125;&#125;. &#123;&#123; item.content &#125;&#125;</span><br><span class="line">                <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"pull-right"</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">el-button</span> <span class="attr">size</span>=<span class="string">"small"</span> <span class="attr">type</span>=<span class="string">"primary"</span> @<span class="attr">click</span>=<span class="string">"restore(index)"</span>&gt;</span>还原<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">template</span>&gt;</span> </span><br><span class="line">          <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">v-else</span>&gt;</span></span><br><span class="line">            暂无已完成事项</span><br><span class="line">          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">el-tab-pane</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">el-tabs</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">el-col</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">el-row</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">  data () &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">      name: <span class="string">'Molunerfinn'</span>,</span></span><br><span class="line"><span class="javascript">      todos: <span class="string">''</span>,</span></span><br><span class="line"><span class="javascript">      activeName: <span class="string">'first'</span>,</span></span><br><span class="line"><span class="undefined">      list:[],</span></span><br><span class="line"><span class="undefined">      count: 0</span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="javascript">  computed: &#123; <span class="comment">// 计算属性用于计算是否已经完成了所有任务</span></span></span><br><span class="line"><span class="undefined">    Done()&#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> count = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> length = <span class="keyword">this</span>.list.length;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">in</span> <span class="keyword">this</span>.list)&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">this</span>.list[i].status == <span class="literal">true</span> ? count += <span class="number">1</span> : <span class="string">''</span>;</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.count = count;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span>(count == length || length == <span class="number">0</span>)&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="literal">true</span></span></span><br><span class="line"><span class="javascript">      &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="literal">false</span></span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="undefined"></span></span><br><span class="line"><span class="undefined">  methods: &#123;</span></span><br><span class="line"><span class="undefined">    addTodos() &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span>(<span class="keyword">this</span>.todos == <span class="string">''</span>)</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">let</span> obj = &#123;</span></span><br><span class="line"><span class="javascript">        status: <span class="literal">false</span>,</span></span><br><span class="line"><span class="javascript">        content: <span class="keyword">this</span>.todos</span></span><br><span class="line"><span class="undefined">      &#125;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.list.push(obj);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.todos = <span class="string">''</span>;</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    finished(index) &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.$<span class="keyword">set</span>(this.list[index],'status',true) // 通过<span class="keyword">set</span>的方法让数组的变动能够让Vue检测到</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.$message(&#123;</span></span><br><span class="line"><span class="javascript">        type: <span class="string">'success'</span>,</span></span><br><span class="line"><span class="javascript">        message: <span class="string">'任务完成'</span></span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    remove(index) &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.list.splice(index,<span class="number">1</span>);</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.$message(&#123;</span></span><br><span class="line"><span class="javascript">        type: <span class="string">'info'</span>,</span></span><br><span class="line"><span class="javascript">        message: <span class="string">'任务删除'</span></span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    restore(index) &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.$<span class="keyword">set</span>(this.list[index],'status',false)</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.$message(&#123;</span></span><br><span class="line"><span class="javascript">        type: <span class="string">'info'</span>,</span></span><br><span class="line"><span class="javascript">        message: <span class="string">'任务还原'</span></span></span><br><span class="line"><span class="undefined">      &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">"stylus"</span> <span class="attr">scoped</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css">  <span class="selector-class">.el-input</span></span></span><br><span class="line"><span class="undefined">    margin 20px auto</span></span><br><span class="line"><span class="css">  <span class="selector-class">.todo-list</span></span></span><br><span class="line"><span class="undefined">    width 100%</span></span><br><span class="line"><span class="undefined">    margin-top 8px</span></span><br><span class="line"><span class="undefined">    padding-bottom 8px</span></span><br><span class="line"><span class="css">    <span class="selector-tag">border-bottom</span> 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#eee</span></span></span><br><span class="line"><span class="undefined">    overflow hidden</span></span><br><span class="line"><span class="undefined">    text-align left</span></span><br><span class="line"><span class="css">    <span class="selector-class">.item</span></span></span><br><span class="line"><span class="undefined">      font-size 20px</span></span><br><span class="line"><span class="css">      &amp;<span class="selector-class">.finished</span></span></span><br><span class="line"><span class="undefined">        text-decoration line-through</span></span><br><span class="line"><span class="css">        <span class="selector-tag">color</span> <span class="selector-id">#ddd</span></span></span><br><span class="line"><span class="css">  <span class="selector-class">.pull-right</span></span></span><br><span class="line"><span class="undefined">    float right</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>页面构建其实没有什么特别好说的，但是因为我自己有踩点坑，所以还是专门讲一下：</p><ol><li><p><code>v-if</code>和<code>v-for</code>放在一个元素内同时使用，因为Vue总会先执行<code>v-for</code>，所以导致<code>v-if</code>不会被执行。替代地，你可以使用一个额外的<code>template</code>元素用来放置<code>v-if</code>或者<code>v-for</code>从而达到同样的目的。这是相关的<a href="https://github.com/vuejs/vue/issues/3106" target="_blank" rel="noopener">issue</a>。</p></li><li><p>计算属性对于直接的数据比如<code>a: 2</code> -&gt; <code>a: 3</code>这样的数据变动可以直接检测到。但是如果是本例中的<code>list</code>的某一项的<code>status</code>这个属性变化了，如果我们直接使用<code>list[index].status = true</code>这样的写法的话，Vue将无法检测到数据变动。替代地，可以使用<code>set</code>方法（全局是<code>Vue.set()</code>，实例中是<code>this.$set()</code>），通过<code>set</code>方法可以让数据的变动变得可以被检测到。从而让计算属性能够捕捉到变化。可以参考官方文档对于响应式原理的<a href="https://cn.vuejs.org/v2/guide/reactivity.html" target="_blank" rel="noopener">描述</a>。</p></li></ol><p><img src="https://img.piegg.cn/vue-koa-demo/todolist.gif" alt="Todolist" title="Todolist"></p><p>写完<code>TodoList</code>之后，我们需要将它和<code>vue-router</code>配合起来，从而使这个单页应用能够进行页面跳转。</p><h3 id="页面路由"><a href="#页面路由" class="headerlink" title="页面路由"></a>页面路由</h3><p>由于不采用服务端渲染，所以页面路由走的是前端路由。安装一下<code>vue-router</code>：<code>yarn add vue-router</code>。</p><p>安装好后，我们挂载一下路由。打开<code>main.js</code>文件改写如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./App'</span></span><br><span class="line"><span class="keyword">import</span> ElementUI <span class="keyword">from</span> <span class="string">'element-ui'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'element-ui/lib/theme-default/index.css'</span></span><br><span class="line"><span class="keyword">import</span> VueRouter <span class="keyword">from</span> <span class="string">'vue-router'</span></span><br><span class="line"></span><br><span class="line">Vue.use(ElementUI);</span><br><span class="line">Vue.use(VueRouter);</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Login <span class="keyword">from</span> <span class="string">`./components/Login`</span></span><br><span class="line"><span class="keyword">import</span> TodoList <span class="keyword">from</span> <span class="string">`./components/TodoList`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router =  <span class="keyword">new</span> VueRouter(&#123;</span><br><span class="line">  mode: <span class="string">'history'</span>, <span class="comment">// 开启HTML5的history模式，可以让地址栏的url长得跟正常页面跳转的url一样。（不过还需要后端配合，讲Koa的时候会说）</span></span><br><span class="line">  base: __dirname, </span><br><span class="line">  routes: [</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">'/'</span>,  <span class="comment">// 默认首页打开是登录页</span></span><br><span class="line">      component: Login</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">'/todolist'</span>,</span><br><span class="line">      component: TodoList</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      path: <span class="string">'*'</span>,</span><br><span class="line">      redirect: <span class="string">'/'</span> <span class="comment">// 输入其他不存在的地址自动跳回首页</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">  router: router, <span class="comment">// 启用router</span></span><br><span class="line">  render: <span class="function"><span class="params">h</span> =&gt;</span> h(App) </span><br><span class="line">&#125;).$mount(<span class="string">'#app'</span>) <span class="comment">//挂载到id为app的元素上</span></span><br></pre></td></tr></table></figure><p>这样就把路由挂载好了，但是你打开页面发现好像还是没有什么变化。这是因为我们没有把路由视图放到页面上。现在我们改写一下<code>APP.vue</code>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- APP.vue --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"./assets/logo.png"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span> <span class="comment">&lt;!-- 原本的Login换成了router-view 这就是路由视图渲染的目标元素--&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">  name: <span class="string">'app'</span> <span class="comment">// 不需要再引入`Login`\`TodoList`组件了，因为在路由里已经注册了</span></span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="css"><span class="selector-id">#app</span> &#123;</span></span><br><span class="line"><span class="undefined">  font-family: 'Avenir', Helvetica, Arial, sans-serif;</span></span><br><span class="line"><span class="undefined">  -webkit-font-smoothing: antialiased;</span></span><br><span class="line"><span class="undefined">  -moz-osx-font-smoothing: grayscale;</span></span><br><span class="line"><span class="undefined">  text-align: center;</span></span><br><span class="line"><span class="css">  <span class="selector-tag">color</span>: <span class="selector-id">#2c3e50</span>;</span></span><br><span class="line"><span class="undefined">  margin-top: 60px;</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后再看一下你的页面，这个时候你如果在地址栏后加上<code>/todolist</code>那么就会跳转到<code>TodoList</code>页面啦。</p><p>不过我们如何通过点击登录按钮跳转到<code>TodoList</code>呢？改写一下<code>Login.vue</code>，就可以跳转了。</p><p>只需要给登录的<code>button</code>加一个方法即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Login.vue --&gt;</span></span><br><span class="line">······</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 给input增加键盘事件，当输入完密码回车也执行loginToDo方法 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">el-input</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">v-model</span>=<span class="string">"password"</span> </span></span><br><span class="line"><span class="tag">  <span class="attr">placeholder</span>=<span class="string">"密码"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">type</span>=<span class="string">"password"</span></span></span><br><span class="line"><span class="tag">  @<span class="attr">keyup.enter.native</span>=<span class="string">"loginToDo"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">el-input</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 增加一个click方法 loginToDo --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">el-button</span> <span class="attr">type</span>=<span class="string">"primary"</span> @<span class="attr">click</span>=<span class="string">"loginToDo"</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">······</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="undefined">  data () &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">      account: <span class="string">''</span>,</span></span><br><span class="line"><span class="javascript">      password: <span class="string">''</span></span></span><br><span class="line"><span class="undefined">    &#125;;</span></span><br><span class="line"><span class="undefined">  &#125;,</span></span><br><span class="line"><span class="undefined">  methods: &#123;</span></span><br><span class="line"><span class="undefined">    loginToDo() &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.$router.push(<span class="string">'/todolist'</span>) <span class="comment">// 编程式路由，通过push方法，改变路由。</span></span></span><br><span class="line"><span class="undefined">    &#125;</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="undefined">&#125;;</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后你就可以通过点击<code>登录</code>按钮进行页面跳转了。并且你可以发现，页面地址从<code>localhost:8080</code>变成了<code>localhost:8080/todolist</code>，长得跟正常的url跳转一样。（但是实际上我们是单页应用，只是在应用内进行页面跳转而已，没有向后端额外请求）</p><p><img src="https://img.piegg.cn/vue-koa-demo/login2todolist.gif" alt="login2todolist" title="login2todolist"></p><p>至此，我们已经完成了一个纯前端的单页应用，能够进行页面跳转，能够做简单的ToDoList的添加和删除和还原。当然这个东西只能算是个能看不能用的东西——因为登录系统有名无实、ToDoList只要页面刷新一下就没了。</p><p>于是我们可以先把前端放一放。开启我们的后端之旅。</p><h2 id="后端环境搭建"><a href="#后端环境搭建" class="headerlink" title="后端环境搭建"></a>后端环境搭建</h2><h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><p>之所以没有用Node界大家普遍喜爱的<code>Mongodb</code>主要是因为之前我用过它，而没有用过<code>MySQL</code>，本着学习的态度，我决定用用<code>MySQL</code>。还有就是<code>Express + Mongodb</code>的教程其实很早之前就已经满大街都是了。所以如果你觉得<code>Mongodb</code>更合你的胃口，看完本文你完全可以用<code>Mongodb</code>构建一个类似的应用。</p><p>去<code>MySQL</code>的<a href="http://dev.mysql.com/downloads/" target="_blank" rel="noopener">官网</a>下载安装对应平台<code>MySQL</code>的<code>Community Server</code>。</p><p>通常来说安装的步骤都是比较简单的。对于<code>MySQL</code>的基本安装、开启步骤可以参考这篇<a href="http://www.rathishkumar.in/2016/01/how-to-install-mysql-server-on-windows.html" target="_blank" rel="noopener">文章</a>，这篇是windows的。当然其他平台的安装也是很方便的，都有相应的包管理工具可以获取。值得注意的就是，安装完<code>MySQL</code>之后你需要设定一下<code>root</code>账户的密码。保证安全性。如果你漏了设定，或者你不知道怎么设定，可以参考这篇<a href="https://www.howtoforge.com/setting-changing-resetting-mysql-root-passwords" target="_blank" rel="noopener">文章</a></p><p>因为我对<code>MySQL</code>的SQL语句不是很熟悉，所以我需要一个可视化的工具来操作<code>MySQL</code>。Windows上我用的是<a href="http://www.heidisql.com/" target="_blank" rel="noopener">HediSQL</a>，macOS上我用的是<a href="https://www.sequelpro.com/" target="_blank" rel="noopener">Sequel Pro</a>。它们都是免费的。</p><p>然后我们可以用这些可视化工具连上MySQL的server（默认端口是3306）之后，创建一个新的数据库，叫做<code>todolist</code>。（当然你也可以用SQL语句:<code>CREATE DATABASE todolist</code>，之后不再赘述）。</p><p>接着我们可以来开始创建数据表了。</p><p>我们需要创建两张表，一张是用户表，一张是待办事项表。用户表用于登录、验证，待办事项表用于展示我们的待办事项。</p><p>创建一张<code>user</code>表，其中<code>password</code>我们稍后会进行<code>bcrypt</code>加密（取128位）。</p><table><thead><tr><th>字段</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>id</td><td>int（自增）</td><td>用户的id</td></tr><tr><td>user_name</td><td>CHAR(50)</td><td>用户的名字</td></tr><tr><td>password</td><td>CHAR(128)</td><td>用户的密码</td></tr></tbody></table><p>创建一张<code>list</code>表，所需的字段是<code>id</code>、<code>user_id</code>、<code>content</code>、<code>status</code>即可。</p><table><thead><tr><th>字段</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td>id</td><td>int（自增）</td><td>list的id</td></tr><tr><td>user_id</td><td>int(11)</td><td>用户的id</td></tr><tr><td>content</td><td>CHAR(255)</td><td>list的内容</td></tr><tr><td>status</td><td>tinyint(1)</td><td>list的状态</td></tr></tbody></table><p>直接跟数据库打交道的部分基本就是这样了。</p><h3 id="Sequelize"><a href="#Sequelize" class="headerlink" title="Sequelize"></a>Sequelize</h3><p>跟数据库打交道的时候我们都需要一个好的操作数据库的工具，能够让我们用比较简单的方法来对数据库进行增删改查。对于<code>Mongodb</code>来说大家熟悉的是<a href="http://mongoosejs.com/" target="_blank" rel="noopener"><code>Mongoose</code></a>以及我用过一个相对更简单点的<a href="https://github.com/Automattic/monk" target="_blank" rel="noopener"><code>Monk</code></a>。对于<code>MySQL</code>，我选用的是<a href="https://github.com/sequelize/sequelize" target="_blank" rel="noopener"><code>Sequelize</code></a>，它支持多种关系型数据库（<code>Sqlite</code>、<code>MySQL</code>、<code>Postgres</code>等），它的操作基本都能返回一个<code>Promise</code>对象，这样在Koa里面我们能够很方便地进行”同步”操作。</p><blockquote><p>更多关于Sequelize的用法，可以参考<a href="http://docs.sequelizejs.com/en/latest/" target="_blank" rel="noopener">官方文档</a>，以及这两篇文章——<a href="http://itbilu.com/nodejs/npm/VkYIaRPz-.html" target="_blank" rel="noopener">Sequelize中文API文档</a>、<a href="https://segmentfault.com/a/1190000003987871" target="_blank" rel="noopener">Sequelize和MySQL对照</a></p></blockquote><p>在用<code>Sequelize</code>连接数据库之前我们需要把数据库的表结构用<code>sequelize-auto</code>导出来。</p><blockquote><p>更多关于<code>sequelize-auto</code>的使用可以参考<a href="https://github.com/sequelize/sequelize-auto" target="_blank" rel="noopener">官方介绍</a>或者<a href="http://itbilu.com/nodejs/npm/41mRdls_Z.html" target="_blank" rel="noopener">这篇文章</a></p></blockquote><p>由此我们需要分别安装这几个依赖：<code>yarn global add sequelize-auto &amp;&amp; yarn add sequelize mysql</code>。</p><blockquote><p>注：上面用yarn安装的mysql是nodejs环境下的mysql驱动。</p></blockquote><p>进入<code>server</code>的目录，执行如下语句<code>sequelize-auto -o &quot;./schema&quot; -d todolist -h 127.0.0.1 -u root -p 3306 -x XXXXX -e mysql</code>，（其中 -o 参数后面的是输出的文件夹目录， -d 参数后面的是数据库名， -h 参数后面是数据库地址， -u 参数后面是数据库用户名， -p 参数后面是端口号， -x 参数后面是数据库密码，这个要根据自己的数据库密码来！ -e 参数后面指定数据库为mysql）</p><p>然后就会在<code>schema</code>文件夹下自动生成两个文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">sequelize, DataTypes</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sequelize.define(<span class="string">'user'</span>, &#123;</span><br><span class="line">    id: &#123;</span><br><span class="line">      type: DataTypes.INTEGER(<span class="number">11</span>), <span class="comment">// 字段类型</span></span><br><span class="line">      allowNull: <span class="literal">false</span>, <span class="comment">// 是否允许为NULL</span></span><br><span class="line">      primaryKey: <span class="literal">true</span>, <span class="comment">// 主键</span></span><br><span class="line">      autoIncrement: <span class="literal">true</span> <span class="comment">// 是否自增</span></span><br><span class="line">    &#125;,</span><br><span class="line">    user_name: &#123;</span><br><span class="line">      type: DataTypes.CHAR(<span class="number">50</span>), <span class="comment">// 最大长度为50的字符串</span></span><br><span class="line">      allowNull: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    password: &#123;</span><br><span class="line">      type: DataTypes.CHAR(<span class="number">32</span>),</span><br><span class="line">      allowNull: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    tableName: <span class="string">'user'</span> <span class="comment">// 表名</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// list.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">sequelize, DataTypes</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sequelize.define(<span class="string">'list'</span>, &#123;</span><br><span class="line">    id: &#123;</span><br><span class="line">      type: DataTypes.INTEGER(<span class="number">11</span>),</span><br><span class="line">      allowNull: <span class="literal">false</span>,</span><br><span class="line">      primaryKey: <span class="literal">true</span>,</span><br><span class="line">      autoIncrement: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    user_id: &#123;</span><br><span class="line">      type: DataTypes.INTEGER(<span class="number">11</span>),</span><br><span class="line">      allowNull: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    content: &#123;</span><br><span class="line">      type: DataTypes.CHAR(<span class="number">255</span>),</span><br><span class="line">      allowNull: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    status: &#123;</span><br><span class="line">      type: DataTypes.INTEGER(<span class="number">1</span>),</span><br><span class="line">      allowNull: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    tableName: <span class="string">'list'</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>自动化工具省去了很多我们手动定义表结构的时间。同时注意到生成的数据库表结构文件都自动帮我们<code>module.exports</code>出来了，所以很方便我们之后的引入。</p><p>在<code>server</code>目录下的<code>config</code>目录下我们新建一个<code>db.js</code>，用于初始化<code>Sequelize</code>和数据库的连接。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// db.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Sequelize = <span class="built_in">require</span>(<span class="string">'sequelize'</span>); <span class="comment">// 引入sequelize</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用url连接的形式进行连接，注意将root: 后面的XXXX改成自己数据库的密码</span></span><br><span class="line"><span class="keyword">const</span> Todolist = <span class="keyword">new</span> Sequelize(<span class="string">'mysql://root:XXXX@localhost/todolist'</span>,&#123;</span><br><span class="line">  define: &#123;</span><br><span class="line">    timestamps: <span class="literal">false</span> <span class="comment">// 取消Sequelzie自动给数据表加入时间戳（createdAt以及updatedAt）</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;) </span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  Todolist <span class="comment">// 将Todolist暴露出接口方便Model调用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着我们去<code>models</code>文件夹里将数据库和表结构文件连接起来。在这个文件夹下新建一个<code>user.js</code>的文件。我们先来写一个查询用户<code>id</code>的东西。</p><p>为此我们可以先在数据库里随意加一条数据：</p><p><img src="https://img.piegg.cn/vue-koa-demo/database-1.png" alt="test" title="test"></p><p>通常我们要查询一个用户id为1的数据，会很自然的想到类似如下的写法：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> userInfo = User.findOne(&#123; <span class="attr">where</span>: &#123; <span class="attr">id</span>: <span class="number">1</span>&#125; &#125;); <span class="comment">// 查询</span></span><br><span class="line"><span class="built_in">console</span>.log(userInfo); <span class="comment">// 输出结果</span></span><br></pre></td></tr></table></figure><p>但是上面的写法实际上是行不通的。因为JS的特性让它的IO操作是异步的。而上面的写法，<code>userInfo</code>将是返回的一个<code>Promise</code>对象，而不是最终的<code>userInfo</code>。如果又想用同步的写法获取异步IO操作得到的数据的话，通常情况下是不能直接得到的。但是在Koa里，由于有<a href="https://github.com/tj/co" target="_blank" rel="noopener"><code>co</code></a>的存在，让这一切变得十分简单。改写如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// models/user.js</span></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'../config/db.js'</span>), </span><br><span class="line">      userModel = <span class="string">'../schema/user.js'</span>; <span class="comment">// 引入user的表结构</span></span><br><span class="line"><span class="keyword">const</span> TodolistDb = db.Todolist; <span class="comment">// 引入数据库</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> User = TodolistDb.import(userModel); <span class="comment">// 用sequelize的import方法引入表结构，实例化了User。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getUserById = <span class="function"><span class="keyword">function</span>* (<span class="params">id</span>)</span>&#123; <span class="comment">// 注意是function* 而不是function 对于需要yield操作的函数都需要这种generator函数。</span></span><br><span class="line">  <span class="keyword">const</span> userInfo = <span class="keyword">yield</span> User.findOne(&#123; <span class="comment">// 用yield控制异步操作，将返回的Promise对象里的数据返回出来。也就实现了“同步”的写法获取异步IO操作的数据</span></span><br><span class="line">    where: &#123;</span><br><span class="line">      id: id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> userInfo <span class="comment">// 返回数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getUserById  <span class="comment">// 导出getUserById的方法，将会在controller里调用</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着我们在<code>controllers</code>写一个user的controller，来执行这个方法，并返回结果。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controllers/user.js </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> user = <span class="built_in">require</span>(<span class="string">'../models/user.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getUserInfo = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="keyword">this</span>.params.id; <span class="comment">// 获取url里传过来的参数里的id</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">yield</span> user.getUserById(id);  <span class="comment">// 通过yield “同步”地返回查询结果</span></span><br><span class="line">  <span class="keyword">this</span>.body = result <span class="comment">// 将请求的结果放到response的body里返回</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getUserInfo <span class="comment">// 把获取用户信息的方法暴露出去 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>写完这个还不能直接请求，因为我们还没有定义路由，请求经过<code>Koa</code>找不到这个路径是没有反应的。</p><p>在<code>routes</code>文件夹下写一个<code>auth.js</code>的文件。（其实<code>user</code>表是用于登录的，所以走<code>auth</code>）</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routes/auth.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> auth = <span class="built_in">require</span>(<span class="string">'../controllers/user.js'</span>); </span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/user/:id'</span>, auth.getUserInfo); <span class="comment">// 定义url的参数是id,用user的auth方法引入router</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router; <span class="comment">// 把router规则暴露出去</span></span><br></pre></td></tr></table></figure><p>至此我们已经接近完成我们的第一个API了，还缺最后一步，将这个路由规则“挂载”到Koa上去。</p><p>回到根目录的<code>app.js</code>，改写如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'koa'</span>)()</span><br><span class="line">  , koa = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</span><br><span class="line">  , json = <span class="built_in">require</span>(<span class="string">'koa-json'</span>)</span><br><span class="line">  , logger = <span class="built_in">require</span>(<span class="string">'koa-logger'</span>)</span><br><span class="line">  , auth = <span class="built_in">require</span>(<span class="string">'./server/routes/auth.js'</span>); <span class="comment">// 引入auth</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>)());</span><br><span class="line">app.use(json());</span><br><span class="line">app.use(logger());</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>* (<span class="params">next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>;</span><br><span class="line">  <span class="keyword">yield</span> next;</span><br><span class="line">  <span class="keyword">let</span> ms = <span class="keyword">new</span> <span class="built_in">Date</span> - start;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'%s %s - %s'</span>, <span class="keyword">this</span>.method, <span class="keyword">this</span>.url, ms);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, ctx</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'server error'</span>, err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">koa.use(<span class="string">'/auth'</span>, auth.routes()); <span class="comment">// 挂载到koa-router上，同时会让所有的auth的请求路径前面加上'/auth'的请求路径。</span></span><br><span class="line"></span><br><span class="line">app.use(koa.routes()); <span class="comment">// 将路由规则挂载到Koa上。</span></span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">8889</span>,() =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'Koa is listening in 8889'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = app;</span><br></pre></td></tr></table></figure><p>打开你的控制台，输入<code>node app.js</code>，一切运行正常没有报错的话，大功告成，我们的第一个API已经构建完成！</p><p>如何测试呢？</p><h3 id="API-Test"><a href="#API-Test" class="headerlink" title="API Test"></a>API Test</h3><p>接口在跟跟前端对接之前，我们应该先进行一遍测试，防止出现问题。在测试接口的工具上，我推荐<a href="https://www.getpostman.com/" target="_blank" rel="noopener"><code>Postman</code></a>，这个工具能够很好的模拟发送的各种请求，方便的查看响应结果，用来进行测试是最好不过了。</p><p><img src="https://img.piegg.cn/vue-koa-demo/postman-1.png" alt="Postman"></p><p>测试成功，我发送了正确的url请求，返回的结果也是我想看到的。我们看到返回的结果实际上是个JSON，这对于我们前后端来说都是十分方便处理的数据格式。</p><p>但是如果我们代码出了问题，返回error了我们该怎么测试呢？如果说控制台能够反馈一定的信息，但是绝对不充分，并且我们很可能不知道哪步出错了导致最终结果出问题。</p><p>所以我推荐用<a href="https://code.visualstudio.com/" target="_blank" rel="noopener">VSCode</a>这个工具来帮我们调试nodejs后端的代码。它能够添加断点，能够很方便地查看请求的信息。并且配合上<a href="https://github.com/remy/nodemon" target="_blank" rel="noopener"><code>nodemon</code></a>这类的工具，调试简直不要更舒服。</p><p>关于<code>VSCode</code>的nodejs调试，可以参考官方的这篇<a href="https://code.visualstudio.com/docs/editor/node-debugging" target="_blank" rel="noopener">文章</a></p><blockquote><p>我自己是用Sublime写代码，用VSCode调试，哈哈。</p></blockquote><h3 id="登录系统的实现"><a href="#登录系统的实现" class="headerlink" title="登录系统的实现"></a>登录系统的实现</h3><p>刚才实现的不过是一个简单的用户信息查询的接口，但是我们要实现的是一个登录系统，所以还需要做一些工作。</p><h4 id="JSON-WEB-TOKEN"><a href="#JSON-WEB-TOKEN" class="headerlink" title="JSON-WEB-TOKEN"></a>JSON-WEB-TOKEN</h4><p>基于cookie或者session的登录验证已经屡见不鲜，前段时间<code>JSON-WEB-TOKEN</code>出来后很是风光了一把。引入了它之后，能够实现真正无状态的请求，而不是基于session和cookie的存储式的有状态验证。</p><p>关于JSON-WEB-TOKEN的描述可以参考这篇<a href="http://blog.leapoahead.com/2015/09/07/user-authentication-with-jwt/?utm_source=tuicool&amp;utm_medium=referral" target="_blank" rel="noopener">文章</a>比较简单，我还推荐一篇<a href="https://segmentfault.com/a/1190000005783306" target="_blank" rel="noopener">文章</a>，将如何使用JSON-WEB-TOKEN写得很清楚。</p><p>另外可以在JSON-WEB-TOKEN的<a href="https://jwt.io/" target="_blank" rel="noopener">官网</a>上感受一下。</p><blockquote><p>Tips：JSON-WEB-TOKEN分三部分，头部信息+主体信息+密钥信息，其中主体传递的信息（是我们存放我们需要的信息的部分）是用BASE64编码的，所以很容易被解码，一定不能存放明文密码这种关键信息！替代地可以存放一些不是特别关键的信息，比如用户名这样能够做区分的信息。</p></blockquote><p>简单来说，运用了JSON-WEB-TOKEN的登录系统应该是这样的：</p><ol><li>用户在登录页输入账号密码，将账号密码（密码进行md5加密）发送请求给后端</li><li>后端验证一下用户的账号和密码的信息，如果符合，就下发一个TOKEN返回给客户端。如果不符合就不发送TOKEN回去，返回验证错误信息。</li><li>如果登录成功，客户端将TOKEN用某种方式存下来（SessionStorage、LocalStorage）,之后要请求其他资源的时候，在请求头（Header）里带上这个TOKEN进行请求。</li><li>后端收到请求信息，先验证一下TOKEN是否有效，有效则下发请求的资源，无效则返回验证错误。</li></ol><p>通过这个TOKEN的方式，客户端和服务端之间的访问，是<code>无状态</code>的：也就是服务端不知道你这个用户到底还在不在线，只要你发送的请求头里的TOKEN是正确的我就给你返回你想要的资源。这样能够不占用服务端宝贵的空间资源，而且如果涉及到服务器集群，如果服务器进行维护或者迁移或者需要CDN节点的分配的话，<code>无状态</code>的设计显然维护成本更低。</p><p>话不多说，我们来把<code>JSON-WEB-TOKEN</code>用到我们的项目中。</p><p><code>yarn add koa-jwt</code>，安装<code>Koa</code>的<code>JSON-WEB-TOKEN</code>库。</p><p>我们需要在<code>models</code>里的<code>user.js</code>加一个方法，通过用户名查找用户：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// models/user.js</span></span><br><span class="line"><span class="comment">// ......</span></span><br><span class="line"><span class="comment">// 前面的省略了</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 新增一个方法，通过用户名查找</span></span><br><span class="line"><span class="keyword">const</span> getUserByName = <span class="function"><span class="keyword">function</span>* (<span class="params">name</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> userInfo = <span class="keyword">yield</span> User.findOne(&#123;</span><br><span class="line">    where: &#123;</span><br><span class="line">      user_name: name</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> userInfo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getUserById, <span class="comment">// 导出getUserById的方法，将会在controller里调用</span></span><br><span class="line">  getUserByName</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后我们写一下<code>controllers</code>里的<code>user.js</code>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controllers/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> user = <span class="built_in">require</span>(<span class="string">'../models/user.js'</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'koa-jwt'</span>); <span class="comment">// 引入koa-jwt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getUserInfo = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="keyword">this</span>.params.id; <span class="comment">// 获取url里传过来的参数里的id</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">yield</span> user.getUserById(id);  <span class="comment">// 通过yield “同步”地返回查询结果</span></span><br><span class="line">  <span class="keyword">this</span>.body = result <span class="comment">// 将请求的结果放到response的body里返回</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postUserAuth = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">this</span>.request.body; <span class="comment">// post过来的数据存在request.body里</span></span><br><span class="line">  <span class="keyword">const</span> userInfo = <span class="keyword">yield</span> user.getUserByName(data.name);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(userInfo != <span class="literal">null</span>)&#123; <span class="comment">// 如果查无此用户会返回null</span></span><br><span class="line">    <span class="keyword">if</span>(userInfo.password != data.password)&#123;</span><br><span class="line">      <span class="keyword">this</span>.body = &#123;</span><br><span class="line">        success: <span class="literal">false</span>, <span class="comment">// success标志位是方便前端判断返回是正确与否</span></span><br><span class="line">        info: <span class="string">'密码错误！'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; <span class="comment">// 如果密码正确</span></span><br><span class="line">      <span class="keyword">const</span> userToken = &#123;</span><br><span class="line">        name: userInfo.user_name,</span><br><span class="line">        id: userInfo.id</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> secret = <span class="string">'vue-koa-demo'</span>; <span class="comment">// 指定密钥，这是之后用来判断token合法性的标志</span></span><br><span class="line">      <span class="keyword">const</span> token = jwt.sign(userToken,secret); <span class="comment">// 签发token</span></span><br><span class="line">      <span class="keyword">this</span>.body = &#123;</span><br><span class="line">        success: <span class="literal">true</span>,</span><br><span class="line">        token: token, <span class="comment">// 返回token</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.body = &#123;</span><br><span class="line">      success: <span class="literal">false</span>,</span><br><span class="line">      info: <span class="string">'用户不存在！'</span> <span class="comment">// 如果用户不存在返回用户不存在</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getUserInfo,</span><br><span class="line">  postUserAuth</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再把<code>routes</code>里的路由规则更新一下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routes/auth.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> auth = <span class="built_in">require</span>(<span class="string">'../controllers/user.js'</span>); </span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/user/:id'</span>, auth.getUserInfo); <span class="comment">// 定义url的参数是id,用user的auth方法引入router</span></span><br><span class="line">router.post(<span class="string">'/user'</span>, auth.postUserAuth);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router; <span class="comment">// 把router规则暴露出去</span></span><br></pre></td></tr></table></figure><p>由此我们写完了用户认证的部分。接下去我们要改写一下前端登录的方法。</p><h4 id="引入Axios"><a href="#引入Axios" class="headerlink" title="引入Axios"></a>引入Axios</h4><p>之前在学<code>Vue</code>的时候一直用的是<a href="https://github.com/pagekit/vue-resource" target="_blank" rel="noopener"><code>vue-resource</code></a>，不过后来<code>Vue2</code>出来之后，Vue官方不再默认推荐它为官方的<code>ajax</code>网络请求库了。替代地推荐了一些其他的库，比如就有我们今天要用的<a href="https://github.com/mzabriskie/axios" target="_blank" rel="noopener"><code>axios</code></a>。我之前也没有用过它，不过看完它的star和简要介绍<code>Promise based HTTP client for the browser and node.js</code>，能够同时支持node和浏览器端的ajax请求工具（还是基于Promised的！），我想就有必要用一用啦。</p><p><code>yarn add axios</code>，安装<code>axios</code>。然后我们在<code>src/main.js</code>里面引入<code>axios</code>：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// scr/main.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Axios <span class="keyword">from</span> <span class="string">'axios'</span></span><br><span class="line"></span><br><span class="line">Vue.prototype.$http = Axios <span class="comment">// 类似于vue-resource的调用方法，之后可以在实例里直接用this.$http.get()等</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Login.vue</span></span><br><span class="line"><span class="comment">// 省略前面的部分</span></span><br><span class="line"></span><br><span class="line"> methods: &#123;</span><br><span class="line">    loginToDo() &#123;</span><br><span class="line">      <span class="keyword">let</span> obj = &#123;</span><br><span class="line">        name: <span class="keyword">this</span>.account,</span><br><span class="line">        password: <span class="keyword">this</span>.password</span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">this</span>.$http.post(<span class="string">'/auth/user'</span>, obj) <span class="comment">// 将信息发送给后端</span></span><br><span class="line">        .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123; <span class="comment">// axios返回的数据都在res.data里</span></span><br><span class="line">          <span class="keyword">if</span>(res.data.success)&#123; <span class="comment">// 如果成功</span></span><br><span class="line">            sessionStorage.setItem(<span class="string">'demo-token'</span>,res.data.token); <span class="comment">// 用sessionStorage把token存下来</span></span><br><span class="line">            <span class="keyword">this</span>.$message(&#123; <span class="comment">// 登录成功，显示提示语</span></span><br><span class="line">              type: <span class="string">'success'</span>,</span><br><span class="line">              message: <span class="string">'登录成功！'</span></span><br><span class="line">            &#125;); </span><br><span class="line">            <span class="keyword">this</span>.$router.push(<span class="string">'/todolist'</span>) <span class="comment">// 进入todolist页面，登录成功</span></span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.$message.error(res.data.info); <span class="comment">// 登录失败，显示提示语</span></span><br><span class="line">            sessionStorage.setItem(<span class="string">'demo-token'</span>,<span class="literal">null</span>); <span class="comment">// 将token清空</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;, (err) =&gt; &#123;</span><br><span class="line">            <span class="keyword">this</span>.$message.error(<span class="string">'请求错误！'</span>)</span><br><span class="line">            sessionStorage.setItem(<span class="string">'demo-token'</span>,<span class="literal">null</span>); <span class="comment">// 将token清空</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h4 id="密码bcrypt加密"><a href="#密码bcrypt加密" class="headerlink" title="密码bcrypt加密"></a>密码bcrypt加密</h4><p>最早的时候我是在前端用了md5加密，但是后来经过提醒这种方式并不安全。md5加密的容易被破解。所以就采用了<code>bcrypt</code>的加密方式。全部走后端加密。也许你会问这样明文给后端发送密码安全吗？没问题，只要用上HTTPS，这将不是问题。</p><p><code>yarn add bcryptjs</code>安装bcryptjs。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// controllers/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> user = <span class="built_in">require</span>(<span class="string">'../models/user.js'</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'koa-jwt'</span>); <span class="comment">// 引入koa-jwt</span></span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcryptjs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getUserInfo = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="keyword">this</span>.params.id; <span class="comment">// 获取url里传过来的参数里的id</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">yield</span> user.getUserById(id);  <span class="comment">// 通过yield “同步”地返回查询结果</span></span><br><span class="line">  <span class="keyword">this</span>.body = result <span class="comment">// 将请求的结果放到response的body里返回</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> postUserAuth = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">this</span>.request.body; <span class="comment">// post过来的数据存在request.body里</span></span><br><span class="line">  <span class="keyword">const</span> userInfo = <span class="keyword">yield</span> user.getUserByName(data.name);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(userInfo != <span class="literal">null</span>)&#123; <span class="comment">// 如果查无此用户会返回null</span></span><br><span class="line">    <span class="keyword">if</span>(!bcrypt.compareSync(data.password, userInfo.password))&#123; <span class="comment">// 验证密码是否正确</span></span><br><span class="line">      <span class="keyword">this</span>.body = &#123;</span><br><span class="line">        success: <span class="literal">false</span>, <span class="comment">// success标志位是方便前端判断返回是正确与否</span></span><br><span class="line">        info: <span class="string">'密码错误！'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123; <span class="comment">// 如果密码正确</span></span><br><span class="line">      <span class="keyword">const</span> userToken = &#123;</span><br><span class="line">        name: userInfo.user_name,</span><br><span class="line">        id: userInfo.id</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> secret = <span class="string">'vue-koa-demo'</span>; <span class="comment">// 指定密钥，这是之后用来判断token合法性的标志</span></span><br><span class="line">      <span class="keyword">const</span> token = jwt.sign(userToken,secret); <span class="comment">// 签发token</span></span><br><span class="line">      <span class="keyword">this</span>.body = &#123;</span><br><span class="line">        success: <span class="literal">true</span>,</span><br><span class="line">        token: token, <span class="comment">// 返回token</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.body = &#123;</span><br><span class="line">      success: <span class="literal">false</span>,</span><br><span class="line">      info: <span class="string">'用户不存在！'</span> <span class="comment">// 如果用户不存在返回用户不存在</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getUserInfo,</span><br><span class="line">  postUserAuth</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>因为我们数据库里还是存着明文的<code>123</code>作为密码，现在要先将它bcrypt化，加密后变为：<code>$2a$10$x3f0Y2SNAmyAfqhKVAV.7uE7RHs3FDGuSYw.LlZhOFoyK7cjfZ.Q6</code>，将其替换掉数据库里的<code>123</code>。不做这步我们将无法登录。</p><p>还没有大功告成，因为我们的界面跑在<code>8080</code>端口，但是Koa提供的API跑在<code>8889</code>端口，所以如果直接通过<code>/auth/user</code>这个url去post是请求不到的。就算写成<code>localhost:8889/auth/user</code>也会因为跨域问题导致请求失败。</p><p>这个时候有两种最方便的解决办法：</p><ol><li>如果是跨域，服务端只要在请求头上加上<a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="noopener"><code>CORS</code></a>，客户端即可跨域发送请求。</li><li>变成同域，即可解决跨域请求问题。</li></ol><p>第一种也很方便，采用<a href="https://github.com/koajs/cors" target="_blank" rel="noopener"><code>kcors</code></a>即可解决。<br>不过为了之后部署方便，我们采用第二种，变成同域请求。</p><p>打开根目录下的<code>config/index.js</code>，找到<code>dev</code>下的<code>proxyTable</code>，利用这个<code>proxyTable</code>我们能够将外部的请求通过<code>webpack</code>转发给本地，也就能够将跨域请求变成同域请求了。</p><p>将<code>proxyTable</code>改写如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> proxyTable: &#123;</span><br><span class="line">  <span class="string">'/auth'</span>:&#123;</span><br><span class="line">    target: <span class="string">'http://localhost:8889'</span>,</span><br><span class="line">    changeOrigin: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">'/api'</span>:&#123;</span><br><span class="line">    target: <span class="string">'http://localhost:8889'</span>,</span><br><span class="line">    changeOrigin: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上面的意思是，我们在组件里请求的地址如果是<code>/api/xxxx</code>实际上请求的是<code>http://localhost:8889/api/xxxx</code>，但是由于<code>webpack</code>帮我们代理了localhost的8889端口的服务，所以我们可以把实际是跨域的请求当做是同域下的接口来调用。</p><p>此时重新启动一下<code>webpack</code>：先<code>ctrl+c</code>退出当前进程，然后<code>npm run dev</code>。</p><p>一切都万事了之后，我们可以看到如下激动人心的画面：</p><p><img src="https://img.piegg.cn/vue-koa-demo/login2todolist-2.gif" alt="login2todolist" title="login2todolist"></p><h4 id="跳转拦截"><a href="#跳转拦截" class="headerlink" title="跳转拦截"></a>跳转拦截</h4><p>虽然我们现在能够成功登录系统了，但是还是存在一个问题：我在地址栏手动将地址改为<code>localhost:8080/todolist</code>我还是能够成功跳转到登录后的界面啊。于是这就需要一个跳转拦截，当没有登录的时候，不管地址栏输入什么地址，最终都重新定向回登录页。</p><p>这个时候，从后端给我们传回来的<code>token</code>就派上大用处。有<code>token</code>就说明我们的身份是经过验证的，否则就是非法的。</p><p><code>vue-router</code>提供了页面跳转的钩子，我们可以在<code>router</code>跳转前进行验证，如果<code>token</code>存在就跳转，如果不存在就返回登录页。</p><p>参考路由的<a href="https://router.vuejs.org/zh-cn/advanced/navigation-guards.html" target="_blank" rel="noopener">导航钩子</a></p><p>打开<code>src/main.js</code>，修改如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/main.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> VueRouter(&#123;....&#125;) <span class="comment">// 省略</span></span><br><span class="line"></span><br><span class="line">router.beforeEach(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> token = sessionStorage.getItem(<span class="string">'demo-token'</span>);</span><br><span class="line">  <span class="keyword">if</span>(to.path == <span class="string">'/'</span>)&#123; <span class="comment">// 如果是跳转到登录页的</span></span><br><span class="line">    <span class="keyword">if</span>(token != <span class="string">'null'</span> &amp;&amp; token != <span class="literal">null</span>)&#123;</span><br><span class="line">      next(<span class="string">'/todolist'</span>) <span class="comment">// 如果有token就转向todolist不返回登录页</span></span><br><span class="line">    &#125;</span><br><span class="line">    next(); <span class="comment">// 否则跳转回登录页</span></span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(token != <span class="string">'null'</span> &amp;&amp; token != <span class="literal">null</span>)&#123;</span><br><span class="line">      next() <span class="comment">// 如果有token就正常转向</span></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      next(<span class="string">'/'</span>) <span class="comment">// 否则跳转回登录页</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;...&#125;) <span class="comment">// 省略</span></span><br></pre></td></tr></table></figure><blockquote><p><strong>注意：一定要确保要调用 <code>next()</code> 方法，否则钩子就不会被 resolved。</strong>如果纯粹调用<code>next(path)</code>这样的方法最终还是会回到<code>.beforeEach()</code>这个钩子里面来，如果没有写对条件就有可能出现死循环，栈溢出的情况。</p></blockquote><p>然后我们就可以看到如下效果：</p><p><img src="https://img.piegg.cn/vue-koa-demo/login2todolist-3.gif" alt="login2todolist" title="login2todolist"></p><blockquote><p>Tips：这种只判断token存不存在就通过的验证是很不安全的，此例只是做了一个演示，实际上还应该进行更深一层的判断，比如从token解包出来的信息里包含我们想要的信息才可以作为有效token，才可以登录。等等。本文只是做一个简要介绍。</p></blockquote><h4 id="解析token"><a href="#解析token" class="headerlink" title="解析token"></a>解析token</h4><p>注意到我们在签发<code>token</code>的时候，写过这样几句话：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// server/controllers/user.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userToken = &#123;</span><br><span class="line">  name: userInfo.user_name,</span><br><span class="line">  id: userInfo.id</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> secret = <span class="string">'vue-koa-demo'</span>; <span class="comment">// 指定密钥，这是之后用来判断token合法性的标志</span></span><br><span class="line"><span class="keyword">const</span> token = jwt.sign(userToken,secret); <span class="comment">// 签发token</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>我们将用户名和id打包进JWT的主体部分，同时我们解密的密钥是<code>vue-koa-demo</code>。所以我们可以通过这个信息，来进行登录后的用户名显示，以及用来区别这个用户是谁，这个用户有哪些<code>Todolist</code>。</p><p>接下来在<code>Todolist</code>页面进行token解析，从而让用户名显示为登录用户名。</p><p><strong>注意：</strong> 前端直接暴露<code>secret-key</code>的做法其实并不安全。正确的做法应该是把token跟用户名和其他不是很重要的信息一起传过来，token只用于验证，而其他信息作为返回值正常返回。这样就不会暴露<code>secret-key</code>了。当然本文只是为了方便说明，给出的一个不恰当的获取用户信息的例子。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// src/components/TodoList.vue</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> jwt <span class="keyword">from</span> <span class="string">'jsonwebtoken'</span> <span class="comment">// 我们安装koa-jwt的时候会自动下载这个依赖</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line"></span><br><span class="line">  created()&#123; <span class="comment">// 组件创建时调用</span></span><br><span class="line">    <span class="keyword">const</span> userInfo = <span class="keyword">this</span>.getUserInfo(); <span class="comment">// 新增一个获取用户信息的方法</span></span><br><span class="line">    <span class="keyword">if</span>(userInfo != <span class="literal">null</span>)&#123;</span><br><span class="line">      <span class="keyword">this</span>.id = userInfo.id;</span><br><span class="line">      <span class="keyword">this</span>.name = userInfo.name;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.id = <span class="string">''</span>;</span><br><span class="line">      <span class="keyword">this</span>.name = <span class="string">''</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  data () &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      name: <span class="string">''</span>, <span class="comment">// 用户名改为空</span></span><br><span class="line">      todos: <span class="string">''</span>,</span><br><span class="line">      activeName: <span class="string">'first'</span>,</span><br><span class="line">      list:[],</span><br><span class="line">      count: <span class="number">0</span>,</span><br><span class="line">      id: <span class="string">''</span> <span class="comment">// 新增用户id属性，用于区别用户</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  computed: &#123;...&#125;, <span class="comment">//省略</span></span><br><span class="line"></span><br><span class="line">  methods: &#123;</span><br><span class="line">    addTodos() &#123;...&#125;, <span class="comment">// 省略</span></span><br><span class="line">    finished(index) &#123;...&#125;,</span><br><span class="line">    remove(index) &#123;...&#125;,</span><br><span class="line">    restore(index) &#123;...&#125;,</span><br><span class="line">    getUserInfo()&#123; <span class="comment">// 获取用户信息</span></span><br><span class="line">      <span class="keyword">const</span> token = sessionStorage.getItem(<span class="string">'demo-token'</span>);</span><br><span class="line">      <span class="keyword">if</span>(token != <span class="literal">null</span> &amp;&amp; token != <span class="string">'null'</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> decode = jwt.decode(token); <span class="comment">// 解析token</span></span><br><span class="line">        <span class="keyword">return</span> decode <span class="comment">// decode解析出来实际上就是&#123;name: XXX,id: XXX&#125;</span></span><br><span class="line">      &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>于是你就可以看到：</p><p><img src="https://img.piegg.cn/vue-koa-demo/todolist-1.png" alt="todolist" title="todolist"></p><p>用户名已经不是我们之前默认的<code>Molunerfinn</code>而是登录名<code>molunerfinn</code>了。</p><h2 id="Todolist-增删改查的实现"><a href="#Todolist-增删改查的实现" class="headerlink" title="Todolist 增删改查的实现"></a>Todolist 增删改查的实现</h2><p>这个部分就是前后端协作了。我们要实现之前在纯前端部分实现的内容。我以最基本的两个方法来举例子：获取<code>Todolist</code>以及增加<code>Todolist</code>，剩下其实思路大同小异，我就提供代码和注释了，我相信也很容易懂。</p><h3 id="Token的发送"><a href="#Token的发送" class="headerlink" title="Token的发送"></a>Token的发送</h3><p>之前说了，用JSON-WEB-TOKEN之后，这个系统的验证就完全依靠token了。如果token正确就下发资源，如果资源不正确，就返回错误信息。</p><p>因为我们用了<code>koa-jwt</code>，所以只需要在每条请求头上加上<code>Authorization</code>属性，值是<code>Bearer {token值}</code>，然后让<code>Koa</code>在接收请求之前验证一下token即可。但是如果每发一条请求就要手动写一句这个，太累了。于是我们可以做到全局<code>Header</code>设定。</p><p>打开<code>src/main.js</code>，在路由跳转的钩子里加上这句：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// scr/main.json</span></span><br><span class="line"></span><br><span class="line">router.beforeEach(<span class="function">(<span class="params">to,<span class="keyword">from</span>,next</span>) =&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> token = sessionStorage.getItem(<span class="string">'demo-token'</span>);</span><br><span class="line">  <span class="keyword">if</span>(to.path == <span class="string">'/'</span>)&#123; </span><br><span class="line">    <span class="keyword">if</span>(token != <span class="string">'null'</span> &amp;&amp; token != <span class="literal">null</span>)&#123;</span><br><span class="line">      next(<span class="string">'/todolist'</span>) </span><br><span class="line">    &#125;</span><br><span class="line">    next(); </span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(token != <span class="string">'null'</span> &amp;&amp; token != <span class="literal">null</span>)&#123;</span><br><span class="line">      Vue.prototype.$http.defaults.headers.common[<span class="string">'Authorization'</span>] = <span class="string">'Bearer '</span> + token; <span class="comment">// 全局设定header的token验证，注意Bearer后有个空格</span></span><br><span class="line">      next() </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      next(<span class="string">'/'</span>) </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这样就完成了token的客户端发送设定。</p><h3 id="Koa端对Token的验证"><a href="#Koa端对Token的验证" class="headerlink" title="Koa端对Token的验证"></a>Koa端对Token的验证</h3><p>接着我们实现两个简单的api，这两个api请求的路径就不是<code>/auth/xxx</code>而是<code>/api/xxx</code>了。我们还需要实现，访问<code>/api/*</code>路径的请求都需要经过<code>koa-jwt</code>的验证，而<code>/auth/*</code>的请求不需要。</p><p>首先去<code>models</code>目录下新建一个<code>todolist.js</code>的文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// server/models/todolist.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> db = <span class="built_in">require</span>(<span class="string">'../config/db.js'</span>), </span><br><span class="line">      todoModel = <span class="string">'../schema/list.js'</span>; <span class="comment">// 引入todolist的表结构</span></span><br><span class="line"><span class="keyword">const</span> TodolistDb = db.Todolist; <span class="comment">// 引入数据库</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Todolist = TodolistDb.import(todoModel); </span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getTodolistById = <span class="function"><span class="keyword">function</span>* (<span class="params">id</span>)</span>&#123;  <span class="comment">// 获取某个用户的全部todolist</span></span><br><span class="line">  <span class="keyword">const</span> todolist = <span class="keyword">yield</span> Todolist.findAll(&#123; <span class="comment">// 查找全部的todolist</span></span><br><span class="line">    where: &#123;</span><br><span class="line">      user_id: id</span><br><span class="line">    &#125;,</span><br><span class="line">    attributes: [<span class="string">'id'</span>,<span class="string">'content'</span>,<span class="string">'status'</span>] <span class="comment">// 只需返回这三个字段的结果即可</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> todolist <span class="comment">// 返回数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createTodolist = <span class="function"><span class="keyword">function</span>* (<span class="params">data</span>)</span>&#123; <span class="comment">// 给某个用户创建一条todolist</span></span><br><span class="line">  <span class="keyword">yield</span> Todolist.create(&#123;</span><br><span class="line">    user_id: data.id, <span class="comment">// 用户的id，用来确定给哪个用户创建</span></span><br><span class="line">    content: data.content,</span><br><span class="line">    status: data.status </span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getTodolistById,</span><br><span class="line">  createTodolist</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着去<code>controllers</code>目录下新建一个<code>todolist.js</code>的文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server/controllers/todolist</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todolist = <span class="built_in">require</span>(<span class="string">'../models/todolist.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getTodolist = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123; <span class="comment">// 获取某个用户的所有todolist</span></span><br><span class="line">  <span class="keyword">const</span> id = <span class="keyword">this</span>.params.id; <span class="comment">// 获取url里传过来的参数里的id</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">yield</span> todolist.getTodolistById(id);  <span class="comment">// 通过yield “同步”地返回查询结果</span></span><br><span class="line">  <span class="keyword">this</span>.body = result <span class="comment">// 将请求的结果放到response的body里返回</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> createTodolist = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123; <span class="comment">// 给某个用户创建一条todolist</span></span><br><span class="line">  <span class="keyword">const</span> data = <span class="keyword">this</span>.request.body; <span class="comment">// post请求，数据是在request.body里的</span></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">yield</span> todolist.createTodolist(data);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.body = &#123;</span><br><span class="line">    success: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getTodolist,</span><br><span class="line">  createTodolist</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后去<code>routes</code>文件夹里新建一个<code>api.js</code>文件：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// server/routes/api.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> todolist = <span class="built_in">require</span>(<span class="string">'../controllers/todolist.js'</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)();</span><br><span class="line"></span><br><span class="line">todolist(router); <span class="comment">// 引入koa-router</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router; <span class="comment">// 导出router规则</span></span><br></pre></td></tr></table></figure><p>最后，去根目录下的<code>app.js</code>，给koa加上新的路由规则：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// app.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'koa'</span>)()</span><br><span class="line">  , koa = <span class="built_in">require</span>(<span class="string">'koa-router'</span>)()</span><br><span class="line">  , json = <span class="built_in">require</span>(<span class="string">'koa-json'</span>)</span><br><span class="line">  , logger = <span class="built_in">require</span>(<span class="string">'koa-logger'</span>)</span><br><span class="line">  , auth = <span class="built_in">require</span>(<span class="string">'./server/routes/auth.js'</span>)</span><br><span class="line">  , api = <span class="built_in">require</span>(<span class="string">'./server/routes/api.js'</span>)</span><br><span class="line">  , jwt = <span class="built_in">require</span>(<span class="string">'koa-jwt'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ..... 省略</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span>* (<span class="params">next</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> start = <span class="keyword">new</span> <span class="built_in">Date</span>;</span><br><span class="line">  <span class="keyword">yield</span> next;</span><br><span class="line">  <span class="keyword">let</span> ms = <span class="keyword">new</span> <span class="built_in">Date</span> - start;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'%s %s - %s'</span>, <span class="keyword">this</span>.method, <span class="keyword">this</span>.url, ms);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(<span class="function"><span class="keyword">function</span> *(<span class="params">next</span>)</span>&#123;  <span class="comment">//  如果JWT验证失败，返回验证失败信息</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">yield</span> next;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">401</span> == err.status) &#123;</span><br><span class="line">      <span class="keyword">this</span>.status = <span class="number">401</span>;</span><br><span class="line">      <span class="keyword">this</span>.body = &#123;</span><br><span class="line">        success: <span class="literal">false</span>,</span><br><span class="line">        token: <span class="literal">null</span>,</span><br><span class="line">        info: <span class="string">'Protected resource, use Authorization header to get access'</span></span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, ctx</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'server error'</span>, err);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">koa.use(<span class="string">'/auth'</span>, auth.routes()); <span class="comment">// 挂载到koa-router上，同时会让所有的auth的请求路径前面加上'/auth'的请求路径。</span></span><br><span class="line">koa.use(<span class="string">"/api"</span>,jwt(&#123;<span class="attr">secret</span>: <span class="string">'vue-koa-demo'</span>&#125;),api.routes()) <span class="comment">// 所有走/api/打头的请求都需要经过jwt中间件的验证。secret密钥必须跟我们当初签发的secret一致</span></span><br><span class="line"></span><br><span class="line">app.use(koa.routes()); <span class="comment">// 将路由规则挂载到Koa上。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...省略</span></span><br></pre></td></tr></table></figure><p>至此，后端的两个api已经构建完成。</p><p>初始化配置相对复杂一些，涉及到<code>model</code>、<code>controllers</code>、<code>routes</code>和<code>app.js</code>，可能会让人望而却步。实际上第一次构建完成之后，后续要添加api，基本上只需要在<code>model</code>和<code>controllers</code>写好方法，定好接口即可，十分方便。</p><h3 id="前端对接接口"><a href="#前端对接接口" class="headerlink" title="前端对接接口"></a>前端对接接口</h3><p>后端接口已经开放，接下来要把前端和后端进行对接。主要有两个对接接口：</p><ol><li>获取某个用户的所有todolist</li><li>创建某个用户的一条todolist</li></ol><p>接下来就是改写<code>Todolist.vue</code>里的方法了：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// todolist.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ... 省略</span></span><br><span class="line"></span><br><span class="line">created()&#123;</span><br><span class="line">  <span class="keyword">const</span> userInfo = <span class="keyword">this</span>.getUserInfo();</span><br><span class="line">  <span class="keyword">if</span>(userInfo != <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = userInfo.id;</span><br><span class="line">    <span class="keyword">this</span>.name = userInfo.name;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">this</span>.name = <span class="string">''</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.getTodolist(); <span class="comment">// 新增：在组件创建时获取todolist</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... 省略</span></span><br><span class="line"></span><br><span class="line">methods: &#123;</span><br><span class="line">  addTodos() &#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.todos == <span class="string">''</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">let</span> obj = &#123;</span><br><span class="line">      status: <span class="literal">false</span>,</span><br><span class="line">      content: <span class="keyword">this</span>.todos,</span><br><span class="line">      id: <span class="keyword">this</span>.id</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.$http.post(<span class="string">'/api/todolist'</span>, obj) <span class="comment">// 新增创建请求</span></span><br><span class="line">      .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(res.status == <span class="number">200</span>)&#123; <span class="comment">// 当返回的状态为200成功时</span></span><br><span class="line">          <span class="keyword">this</span>.$message(&#123;</span><br><span class="line">            type: <span class="string">'success'</span>,</span><br><span class="line">            message: <span class="string">'创建成功！'</span> </span><br><span class="line">          &#125;)</span><br><span class="line">          <span class="keyword">this</span>.getTodolist(); <span class="comment">// 获得最新的todolist</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.$message.error(<span class="string">'创建失败！'</span>) <span class="comment">// 当返回不是200说明处理出问题</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, (err) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.$message.error(<span class="string">'创建失败！'</span>) <span class="comment">// 当没有返回值说明服务端错误或者请求没发送出去</span></span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">      &#125;)</span><br><span class="line">    <span class="keyword">this</span>.todos = <span class="string">''</span>; <span class="comment">// 将当前todos清空</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ... 省略一些方法</span></span><br><span class="line">  getTodolist()&#123;</span><br><span class="line">    <span class="keyword">this</span>.$http.get(<span class="string">'/api/todolist/'</span> + <span class="keyword">this</span>.id) <span class="comment">// 向后端发送获取todolist的请求</span></span><br><span class="line">      .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(res.status == <span class="number">200</span>)&#123;</span><br><span class="line">          <span class="keyword">this</span>.list = res.data <span class="comment">// 将获取的信息塞入实例里的list</span></span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">this</span>.$message.error(<span class="string">'获取列表失败！'</span>)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;, (err) =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.$message.error(<span class="string">'获取列表失败！'</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(err)</span><br><span class="line">      &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此，前后端的部分已经完整构建。让我们来看看效果：</p><p><img src="https://img.piegg.cn/vue-koa-demo/login2todolist-4.gif" alt="todolist" title="todolist"></p><p>做到这一步的时候其实我们的应用已经基本完成了。最后的收尾工作，让我们来收一下。</p><p>原本的前端版本还有<code>完成</code>、<code>删除</code>、<code>还原</code>三种状态，其中<code>完成</code>和<code>还原</code>只是状态的切换（更新），所以可以算是一个api，然后就是删除是单独一个api。于是我们就能算是完成了增、删、改、查了。接下去的部分就提供代码就行，其实思路跟之前的是一样的，只不过操作的函数不一样罢了。</p><h3 id="Todolist的改、删"><a href="#Todolist的改、删" class="headerlink" title="Todolist的改、删"></a>Todolist的改、删</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// server/models/todolist.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...省略</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> removeTodolist = <span class="function"><span class="keyword">function</span>* (<span class="params">id,user_id</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> Todolist.destroy(&#123;</span><br><span class="line">    where: &#123;</span><br><span class="line">      id,</span><br><span class="line">      user_id</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> updateTodolist = <span class="function"><span class="keyword">function</span>* (<span class="params">id,user_id,status</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> Todolist.update(</span><br><span class="line">    &#123;</span><br><span class="line">      status</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      where: &#123;</span><br><span class="line">        id,</span><br><span class="line">        user_id</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getTodolistById,</span><br><span class="line">  createTodolist,</span><br><span class="line">  removeTodolist,</span><br><span class="line">  updateTodolist</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// server/controllers/todolist.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ... 省略</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> removeTodolist = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="keyword">this</span>.params.id;</span><br><span class="line">  <span class="keyword">const</span> user_id = <span class="keyword">this</span>.params.userId;</span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">yield</span> todolist.removeTodolist(id,user_id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.body = &#123;</span><br><span class="line">    success: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> updateTodolist = <span class="function"><span class="keyword">function</span>* (<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="keyword">this</span>.params.id;</span><br><span class="line">  <span class="keyword">const</span> user_id = <span class="keyword">this</span>.params.userId;</span><br><span class="line">  <span class="keyword">let</span> status = <span class="keyword">this</span>.params.status; </span><br><span class="line">  status == <span class="string">'0'</span> ? status = <span class="literal">true</span> : status =  <span class="literal">false</span>;<span class="comment">// 状态反转（更新）</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">yield</span> todolist.updateTodolist(id,user_id,status);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.body = &#123;</span><br><span class="line">    success: <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">router</span>) =&gt;</span> &#123;</span><br><span class="line">  getTodolist,</span><br><span class="line">  createTodolist,</span><br><span class="line">  removeTodolist,</span><br><span class="line">  updateTodolist</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">&lt;!-- src/components/TodoList.vue --&gt;</span></span><br><span class="line"></span><br><span class="line">....</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 把完成和还原的方法替换成了update --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">el-button</span> <span class="attr">size</span>=<span class="string">"small"</span> <span class="attr">type</span>=<span class="string">"primary"</span> @<span class="attr">click</span>=<span class="string">"update(index)"</span>&gt;</span>完成<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">....</span><br><span class="line"><span class="tag">&lt;<span class="name">el-button</span> <span class="attr">size</span>=<span class="string">"small"</span> <span class="attr">type</span>=<span class="string">"primary"</span> @<span class="attr">click</span>=<span class="string">"update(index)"</span>&gt;</span>还原<span class="tag">&lt;/<span class="name">el-button</span>&gt;</span></span><br><span class="line">....</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="comment">// ....省略</span></span></span><br><span class="line"><span class="undefined">  methods:&#123;</span></span><br><span class="line"><span class="javascript">    <span class="comment">// ... 省略</span></span></span><br><span class="line"><span class="undefined">    update(index) &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.$http.put(<span class="string">'/api/todolist/'</span>+ <span class="keyword">this</span>.id + <span class="string">'/'</span> + <span class="keyword">this</span>.list[index].id + <span class="string">'/'</span> + <span class="keyword">this</span>.list[index].status)</span></span><br><span class="line"><span class="javascript">        .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">if</span>(res.status == <span class="number">200</span>)&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">this</span>.$message(&#123;</span></span><br><span class="line"><span class="javascript">              type: <span class="string">'success'</span>,</span></span><br><span class="line"><span class="javascript">              message: <span class="string">'任务状态更新成功！'</span></span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="javascript">            <span class="keyword">this</span>.getTodolist();</span></span><br><span class="line"><span class="javascript">          &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">this</span>.$message.error(<span class="string">'任务状态更新失败！'</span>)</span></span><br><span class="line"><span class="undefined">          &#125;</span></span><br><span class="line"><span class="undefined">        &#125;, (err) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">this</span>.$message.error(<span class="string">'任务状态更新失败！'</span>)</span></span><br><span class="line"><span class="javascript">          <span class="built_in">console</span>.log(err)</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">    remove(index) &#123;</span></span><br><span class="line"><span class="javascript">      <span class="keyword">this</span>.$http.delete(<span class="string">'/api/todolist/'</span>+ <span class="keyword">this</span>.id + <span class="string">'/'</span> + <span class="keyword">this</span>.list[index].id)</span></span><br><span class="line"><span class="javascript">        .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">if</span>(res.status == <span class="number">200</span>)&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">this</span>.$message(&#123;</span></span><br><span class="line"><span class="javascript">              type: <span class="string">'success'</span>,</span></span><br><span class="line"><span class="javascript">              message: <span class="string">'任务删除成功！'</span></span></span><br><span class="line"><span class="undefined">            &#125;)</span></span><br><span class="line"><span class="javascript">            <span class="keyword">this</span>.getTodolist();</span></span><br><span class="line"><span class="javascript">          &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">this</span>.$message.error(<span class="string">'任务删除失败！'</span>)</span></span><br><span class="line"><span class="undefined">          &#125;</span></span><br><span class="line"><span class="undefined">        &#125;, (err) =&gt; &#123;</span></span><br><span class="line"><span class="javascript">          <span class="keyword">this</span>.$message.error(<span class="string">'任务删除失败！'</span>)</span></span><br><span class="line"><span class="javascript">          <span class="built_in">console</span>.log(err)</span></span><br><span class="line"><span class="undefined">        &#125;)</span></span><br><span class="line"><span class="undefined">    &#125;,</span></span><br><span class="line"><span class="undefined">  &#125;</span></span><br><span class="line"><span class="javascript"><span class="comment">// ... 省略</span></span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">....</span><br></pre></td></tr></table></figure><p>让我们来看看最后99%成品的效果吧：</p><p><img src="https://img.piegg.cn/vue-koa-demo/todolist-5.gif" alt="Todolist" title="todolist"></p><h2 id="项目部署"><a href="#项目部署" class="headerlink" title="项目部署"></a>项目部署</h2><p>很多教程到类似于我上面的部分就结束了。但是实际上我们做一个项目最想要的就是部署给大家用不是么？</p><p>在部署这块有些坑，需要让大家也一起知道一下。这个项目是个全栈项目（虽然是个很简单的。。。），所以就涉及到前后端通信的问题，也就会涉及到是同域请求还是跨域请求。</p><p>我们也说过，要解决这个问题有两种方便的解决办法，第一种，服务端加上<code>cors</code>，客户端就可以随意的跨域请求。但是这样会有个问题，因为我们是以同域的形式开发，请求的地址也是写的相对地址：<code>/api/*</code>、<code>auth/*</code>这样的路径，访问的路径的自然是同域。如果要在服务端加上<code>cors</code>，我们还需要将我们的所有请求地址改成<code>localhost:8889/api/*</code>，<code>localhost:8889/auth/*</code>，这样的话，如果服务端的端口号一变，我们还需要重新修改前端所有的请求地址。这样很不方便也很不科学。</p><p>因此，要将请求变为同域才是最好的解决办法——不管服务端端口号怎么变，只要是同域都可以请求到。</p><p>于是要把Vue和Koa结合起来变成一个完整的项目（之前实际上都是在开发模式下，webpack帮我们进行请求的代理转发，所以看起来像是同域请求，而Vue和Koa并没有完全结合起来），就得在生产模式下，将Vue的静态文件交给Koa“托管”，所有访问前端的请求全部走Koa端，包括静态文件资源的请求，也走Koa端，把Koa作为一个Vue项目的静态资源服务器，这样就可以让Vue里的请求走的都是同域了。（相当于，之前开发模式是webpack开启了一个服务器托管了Vue的资源和请求，现在生产模式下改成Koa托管Vue的资源和请求）</p><p>要在开发和生产模式改变不同的托管服务器，其实也很简单，只需要在生产模式下，用Koa的静态资源服务中间件托管构建好的Vue文件即可。</p><h3 id="Webpack打包"><a href="#Webpack打包" class="headerlink" title="Webpack打包"></a>Webpack打包</h3><p>部署之前我们要用Webpack将我们的前端项目打包输出一下。但是如果直接用<code>npm run build</code>，你会发现打包出来的文件太大了：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">                                                  Asset       Size  Chunks             Chunk Names</span><br><span class="line">    static/css/app.d9034fc06fd57ce00d6e75ed49f0dafe.css     120 kB    2, 0  [emitted]  app</span><br><span class="line">                 static/fonts/element-icons.a61be9c.eot    13.5 kB          [emitted]</span><br><span class="line">                   static/img/element-icons.09162bc.svg    17.4 kB          [emitted]</span><br><span class="line">             static/js/manifest.8ea250834bdc80e4d73b.js  832 bytes       0  [emitted]  manifest</span><br><span class="line">               static/js/vendor.75bbe7ecea37b0d4c62d.js     623 kB    1, 0  [emitted]  vendor</span><br><span class="line">                  static/js/app.e2d125562bfc4c57f9cb.js    16.5 kB    2, 0  [emitted]  app</span><br><span class="line">                 static/fonts/element-icons.b02bdc1.ttf    13.2 kB          [emitted]</span><br><span class="line">         static/js/manifest.8ea250834bdc80e4d73b.js.map    8.86 kB       0  [emitted]  manifest</span><br><span class="line">           static/js/vendor.75bbe7ecea37b0d4c62d.js.map    3.94 MB    1, 0  [emitted]  vendor</span><br><span class="line">              static/js/app.e2d125562bfc4c57f9cb.js.map    64.8 kB    2, 0  [emitted]  app</span><br><span class="line">static/css/app.d9034fc06fd57ce00d6e75ed49f0dafe.css.map     151 kB    2, 0  [emitted]  app</span><br><span class="line">                                             index.html  563 bytes          [emitted]</span><br></pre></td></tr></table></figure><p>竟然有3.94MB的map文件。这肯定是不能接受的。于是要修改一下webpack的输出的设置，取消输出map文件。</p><p>找到根目录下的<code>config/index.js</code>：把<code>productionSourceMap: true</code>这句话改成<code>productionSourceMap: false</code>。然后再执行一遍<code>npm run build</code>。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">                                              Asset       Size  Chunks             Chunk Names</span><br><span class="line">             static/fonts/element-icons.a61be9c.eot    13.5 kB          [emitted]</span><br><span class="line">             static/fonts/element-icons.b02bdc1.ttf    13.2 kB          [emitted]</span><br><span class="line">               static/img/element-icons.09162bc.svg    17.4 kB          [emitted]</span><br><span class="line">         static/js/manifest.3ba218c80028a707a728.js  774 bytes       0  [emitted]  manifest</span><br><span class="line">           static/js/vendor.75bbe7ecea37b0d4c62d.js     623 kB    1, 0  [emitted]  vendor</span><br><span class="line">              static/js/app.b6acaca2531fc0baa447.js    16.5 kB    2, 0  [emitted]  app</span><br><span class="line">static/css/app.d9034fc06fd57ce00d6e75ed49f0dafe.css     120 kB    2, 0  [emitted]  app</span><br><span class="line">                                         index.html  563 bytes          [emitted]</span><br></pre></td></tr></table></figure><p>把sourceMap去掉了之后，体积就小下来了。虽然600+kb的大小还是有点大，不过放到服务端，gzip之后只剩150+kb的体积勉强还是可以接受。当然，对于webpack输出的优化，不是本文讨论的范围，有很多更好的文章讲述了这个东西，故本文不再详细展开。</p><p>打包好后就是相当于输出了一堆静态文件，当然这堆静态文件需要放在服务端才可以访问。我们要将这堆静态资源用Koa托管。</p><h3 id="Koa-serve静态资源"><a href="#Koa-serve静态资源" class="headerlink" title="Koa serve静态资源"></a>Koa serve静态资源</h3><p><code>yarn add koa-static</code></p><p>打开<code>app.js</code>，引入两个新依赖，其中<code>path</code>是nodejs原生自带。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// .... </span></span><br><span class="line"><span class="keyword">const</span> path =<span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line">    , serve = <span class="built_in">require</span>(<span class="string">'koa-static'</span>);</span><br><span class="line"><span class="comment">// ....</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 静态文件serve在koa-router的其他规则之上 </span></span><br><span class="line">app.use(serve(path.resolve(<span class="string">'dist'</span>))); <span class="comment">// 将webpack打包好的项目目录作为Koa静态文件服务的目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面这些是之前就有的。。。为了方便找位置故标示出来</span></span><br><span class="line">koa.use(<span class="string">'/auth'</span>, auth.routes());</span><br><span class="line">koa.use(<span class="string">"/api"</span>,jwt(&#123;<span class="attr">secret</span>: <span class="string">'vue-koa-demo'</span>&#125;),api.routes()) </span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>然后重新运行一遍<code>node app.js</code>，看到输出<code>Koa is listening in 8889</code>后，你可以打开浏览器<code>localhost:8889</code>就可以看到如下情景：</p><p><img src="https://img.piegg.cn/vue-koa-demo/vue-koa.png" alt="vue-koa"></p><p>至此已经基本上接近尾声，不过还存在一个问题：如果我们登录进去之后，在todolist页面一刷新，就会出现：</p><p><img src="https://img.piegg.cn/vue-koa-demo/404.png" alt="404" title="404"></p><p>为什么会出现这种情况？简单来说是因为我们使用了前端路由，用了HTML5 的History模式，如果没有做其他任何配置的话，刷新页面，那么浏览器将会去服务端访问这个页面地址，因为服务端并没有配置这个地址的路由，所以自然就返回404 Not Found了。</p><p>详细可以参考vue-router的<a href="https://router.vuejs.org/zh-cn/essentials/history-mode.html" target="_blank" rel="noopener">这篇文档</a></p><p>该怎么解决？其实也很简单，多加一个中间件：<code>koa-history-api-fallback</code>即可.</p><p><code>yarn add koa-history-api-fallback</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//... 省略</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> historyApiFallback = <span class="built_in">require</span>(<span class="string">'koa-history-api-fallback'</span>); <span class="comment">// 引入依赖</span></span><br><span class="line"></span><br><span class="line">app.use(<span class="built_in">require</span>(<span class="string">'koa-bodyparser'</span>)());</span><br><span class="line">app.use(json());</span><br><span class="line">app.use(logger());</span><br><span class="line">app.use(historyApiFallback()); <span class="comment">// 在这个地方加入。一定要加在静态文件的serve之前，否则会失效。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure><p>这个时候，你再重新启动一下koa，登录之后再刷新页面，就不会再出现404 Not Found了。</p><h3 id="API-Test-1"><a href="#API-Test-1" class="headerlink" title="API Test"></a>API Test</h3><p>本来写到上面基本本文已经算是结束了。但是由于我在开发的过程中遇到了一些问题，所以还需要做一些微调。</p><p>我们知道koa的use方法是有顺序只差的。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line">app.use(A);</span><br><span class="line">app.use(B);</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line">app.use(B);</span><br><span class="line">app.use(A);</span><br></pre></td></tr></table></figure><p>这二者是有区别的，谁先被use，谁的规则就放到前面先执行。</p><p>因此如果我们将静态文件的serve以及<code>historyApiFallback</code>放在了api的请求之前，那么用postman测试api的时候总会先返回完整的页面：</p><p><img src="https://img.piegg.cn/vue-koa-demo/postman.png" alt="postman"></p><p>因此正确的做法，应该是将它们放到我们写的api的规则之后：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">koa.use(<span class="string">'/auth'</span>, auth.routes()); <span class="comment">// 挂载到koa-router上，同时会让所有的auth的请求路径前面加上'/auth'的请求路径。</span></span><br><span class="line">koa.use(<span class="string">"/api"</span>,jwt(&#123;<span class="attr">secret</span>: <span class="string">'vue-koa-demo'</span>&#125;),api.routes()) <span class="comment">// 所有走/api/打头的请求都需要经过jwt验证。</span></span><br><span class="line"></span><br><span class="line">app.use(koa.routes()); <span class="comment">// 将路由规则挂载到Koa上。</span></span><br><span class="line"></span><br><span class="line">app.use(historyApiFallback()); <span class="comment">// 将这两个中间件挂载在api的路由之后</span></span><br><span class="line">app.use(serve(path.resolve(<span class="string">'dist'</span>))); <span class="comment">// 将webpack打包好的项目目录作为Koa静态文件服务的目录</span></span><br></pre></td></tr></table></figure><p>这样就能正常返回数据了。</p><h3 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h3><p>真正部署到服务器的时候，我们肯定不会让大家输入<code>域名:8889</code>这样的方式让大家访问。所以需要用Nginx监听80端口，把访问我们指定域名的请求引导转发给Koa服务端。</p><p>大致的<code>nginx.conf</code>如下：</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># ....</span></span><br><span class="line">  <span class="attribute">upstream</span> koa.server&#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8889</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>   <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> xxx.xxx.com;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">      <span class="attribute">proxy_pass</span> http://koa.server;</span><br><span class="line">      <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#....</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">#....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果有精力还可以配置一下Nginx的Gzip，能让请求的JS\CSS\HTML等静态文件更小，响应速度更快些。</p><h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>至此，我们已经完成了一个从前端到后端，从本地到服务器的完整项目。虽然它真的是个很简单的小东西，被大家也已经用其他的方式写烂了（比如用localStorage做存储）。但是它作为一个完整的前后端的DEMO，我觉得让大家入门也相对更容易一些，能够体会到全栈开发也不是想象中的“那么难”（入门的难度还是可以接受的嘛）。有了Nodejs之后我们能够做的事真的好多！</p><p>当然，由于篇幅有限，本文能够讲述东西毕竟不够多，而且讲的东西也不可能面面俱到，很多东西都是点到即止，让大家能够自己发挥。其实还想讲讲<code>Event Bus</code>的简单使用，还有分页的基本实现等等，东西太多了，一时间大家消化不了。</p><p>实际上我在做前段时间的项目的时候，也是完全不知道怎么把Vue和Koa结合起来开发。我甚至不知道怎么用Koa来提供API，我只会用Koa来做服务端渲染，比如那些JADE\EJS等模板引擎渲染的页面。所以之前那个项目做完让我自己学到良多东西，故而也分享给大家。</p><p>实际上本文的Koa的api提供的形式也尽量和RESTful靠拢了，因此你也可以学会如何通过Koa提供RESTful形式的API了。</p><p>最后放上本文项目的Github<a href="https://github.com/Molunerfinn/vue-koa-demo" target="_blank" rel="noopener">地址</a>，如果这个项目对你有帮助，希望大家可以fork，给我提建议，如果再有时间，可以点个Star那就更好啦~</p><p>另外，本文的版本是用Koa1写成的。仓库已经更新Koa2。从Koa1-&gt;Koa2并没有什么难度，其实很关键的两点是：</p><ol><li>用<code>async await</code>替代<code>yield generation</code></li><li>用<code>koa2</code>的中间件替代<code>koa1</code>的中间件，原因同上一条</li></ol><p>互相学习，如果能从这个项目里学到东西我就很开心啦~</p><blockquote><p>注： 转载需经过同意，必须署名</p></blockquote></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Molunerfinn</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://molunerfinn.com/Vue+Koa/">https://molunerfinn.com/Vue+Koa/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/前端/">前端</a><a class="post-meta__tags" href="/tags/Vue/">Vue</a><a class="post-meta__tags" href="/tags/Nodejs/">Nodejs</a><a class="post-meta__tags" href="/tags/Koa/">Koa</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://ws1.sinaimg.cn/large/8700af19ly1fjmba1eumhj20jz0jzq4b.jpg"><div class="post-qr-code__desc">支付宝打赏</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="https://ws1.sinaimg.cn/large/8700af19ly1fjmbbmp7uwj20jm0jmt9a.jpg"><div class="post-qr-code__desc">微信打赏</div></div></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5994f8f0fea9a5f4" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/Webpack-Optimize/"><i class="fa fa-chevron-left"></i><span>Vuejs项目的Webpack2构建优化</span></a></div><div class="next-post pull-right"><a href="/gear-system/"><span>【译】Having fun with Html5 Canvas</span><i class="fa fa-chevron-right"></i></a></div></nav><div class="post-adv"><a href="https://www.vultr.com/?ref=7231808"><img src="https://www.vultr.com/media/banner_1.png" width="100%" height="90"></a></div><div id="gitalk-container"></div><script>var gitalk=new Gitalk({clientID:"f7b6cca0b0a65f07a027",clientSecret:"84b5ccac558161d1bdaa50fc498619fca9d4c640",repo:"Molunerfinn.github.io",owner:"Molunerfinn",admin:"Molunerfinn",id:md5(decodeURI(location.pathname)),language:"en"});gitalk.render("gitalk-container")</script></div></div><footer class="footer-bg" style="background-image:url(https://ws1.sinaimg.cn/large/8700af19ly1fvpabr30o6j22yo1o0q7i.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2015 - 2019 By Molunerfinn</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/algolia.js"></script><script>/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)&&($("#nav").addClass("is-mobile"),$("footer").addClass("is-mobile"))</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>